#+title: Noonker's Config


Below is my configuration for Emacs. It is a literate config that can be installed by running =org-babel-tangle= or by using the hotkey =C-c C-v C-t=.
It is broken up into several sections:
 - Bootstrap - Code that instantiates the package manager
 - Behavior - Packages & tweaks to the behavior of emacs
 - Tools - Any packages which modify the behavior of emacs
 - Programming - Packages & tweaks to programming modes
 - Text - Any packages which are used primarily for writing of text (mostly org-mode)
 - Custom Functions - Any simple functions I've added to enrich my emacs life
* Bootstrap Straight.el

This section sets up [[https://github.com/radian-software/straight.el][straight.el]] with [[https://github.com/jwiegley/use-package][use-package]] to simplify setup of emacs. These packages allow me to control how the packages are installed, when they are loaded, and which configurations should be run with them.

#+begin_src emacs-lisp :tangle ~/.emacs
(defvar bootstrap-version)

(let ((bootstrap-file
       (expand-file-name "straight/repos/straight.el/bootstrap.el" user-emacs-directory))
      (bootstrap-version 5))
  (unless (file-exists-p bootstrap-file)
    (with-current-buffer
	(url-retrieve-synchronously
	 "https://raw.githubusercontent.com/raxod502/straight.el/develop/install.el"
	 'silent 'inhibit-cookies)
      (goto-char (point-max))
      (eval-print-last-sexp)))
  (load bootstrap-file nil 'nomessage))

;; Tell use-package to use straight to install applications
(straight-use-package 'use-package)

;; Update builtins too
(setq package-install-upgrade-built-in t)

(use-package straight
  :custom
  ;; add project and flymake to the pseudo-packages variable so straight.el doesn't download a separate version than what eglot downloads.
  (straight-built-in-pseudo-packages '(xref emacs nadvice python image-mode project flymake))
  (straight-use-package-by-default t))
#+end_src

* Company

Company is an autocomplete option framework for emacs

#+begin_src emacs-lisp :tangle ~/.emacs
(use-package company
  :config
  (global-company-mode)
  (setq company-dabbrev-downcase 0)
  (setq company-idle-delay 0.38)
  (setq company-minimum-prefix-length 2)

  (defun complete-or-indent ()
    (interactive)
    (if (company-manual-begin)
	(company-complete-common)
      (indent-according-to-mode)))

  (defun indent-or-complete ()
    (interactive)
    (if (looking-at "\\_>")
	(company-complete-common)
      (indent-according-to-mode))))
#+end_src

* Behavior
** Vertico
#+begin_src emacs-lisp :tangle ~/.emacs
;; Enable vertico

(use-package vertico
  :ensure t
  :bind (:map vertico-map
              :map minibuffer-local-map
              ("M-h" . backward-kill-word))
  :init
  (vertico-mode)
  )

;; A few more useful configurations...
(use-package emacs
  :init
  ;; Add prompt indicator to `completing-read-multiple'.
  ;; We display [CRM<separator>], e.g., [CRM,] if the separator is a comma.
  (defun crm-indicator (args)
    (cons (format "[CRM%s] %s"
                  (replace-regexp-in-string
                   "\\`\\[.*?]\\*\\|\\[.*?]\\*\\'" ""
                   crm-separator)
                  (car args))
          (cdr args)))
  (advice-add #'completing-read-multiple :filter-args #'crm-indicator)

  ;; Do not allow the cursor in the minibuffer prompt
  (setq minibuffer-prompt-properties
        '(read-only t cursor-intangible t face minibuffer-prompt))
  (add-hook 'minibuffer-setup-hook #'cursor-intangible-mode)

  ;; Emacs 28: Hide commands in M-x which do not work in the current mode.
  ;; Vertico commands are hidden in normal buffers.
  ;; (setq read-extended-command-predicate
  ;;       #'command-completion-default-include-p)

  ;; Enable recursive minibuffers
  (setq enable-recursive-minibuffers t))

;; Optionally use the `orderless' completion style.
(use-package orderless
  :init
  ;; Configure a custom style dispatcher (see the Consult wiki)
  ;; (setq orderless-style-dispatchers '(+orderless-consult-dispatch orderless-affix-dispatch)
  ;;       orderless-component-separator #'orderless-escapable-split-on-space)
  (setq completion-styles '(orderless basic)
        completion-category-defaults nil
        completion-category-overrides '((file (styles partial-completion)))))

(use-package marginalia
  :ensure t
  :config
  (marginalia-mode))

(use-package embark
  :ensure t

  :bind
  (("C-." . embark-act)         ;; pick some comfortable binding
   ("C-;" . embark-dwim)        ;; good alternative: M-.
   ("C-h B" . embark-bindings)) ;; alternative for `describe-bindings'

  :init

  ;; Optionally replace the key help with a completing-read interface
  (setq prefix-help-command #'embark-prefix-help-command)

  ;; Show the Embark target at point via Eldoc.  You may adjust the Eldoc
  ;; strategy, if you want to see the documentation from multiple providers.
  (add-hook 'eldoc-documentation-functions #'embark-eldoc-first-target)
  ;; (setq eldoc-documentation-strategy #'eldoc-documentation-compose-eagerly)

  :config

  ;; Hide the mode line of the Embark live/completions buffers
  (add-to-list 'display-buffer-alist
               '("\\`\\*Embark Collect \\(Live\\|Completions\\)\\*"
                 nil
                 (window-parameters (mode-line-format . none)))))

(use-package consult)
(use-package embark-consult)
(use-package consult-ag)
(use-package consult-dir)
(use-package consult-org-roam)
(global-set-key (kbd "C-2") #'switch-to-buffer)
(global-set-key (kbd "C-3") #'yank-from-kill-ring)
(global-set-key (kbd "C-4") #'bookmark-jump)

(use-package corfu
  ;; Optional customizations
  ;; :custom
  ;; (corfu-cycle t)                ;; Enable cycling for `corfu-next/previous'
  ;; (corfu-quit-at-boundary nil)   ;; Never quit at completion boundary
  ;; (corfu-quit-no-match nil)      ;; Never quit, even if there is no match
  ;; (corfu-preview-current nil)    ;; Disable current candidate preview
  ;; (corfu-preselect 'prompt)      ;; Preselect the prompt
  ;; (corfu-on-exact-match nil)     ;; Configure handling of exact matches

  ;; Enable Corfu only for certain modes. See also `global-corfu-modes'.
 ;; :hook ((prog-mode . corfu-mode)
  ;;        (shell-mode . corfu-mode)
  ;;        (eshell-mode . corfu-mode))

  ;; Recommended: Enable Corfu globally.  This is recommended since Dabbrev can
  ;; be used globally (M-/).  See also the customization variable
  ;; `global-corfu-modes' to exclude certain modes.
  :init
  (global-corfu-mode))

;; A few more useful configurations...
(use-package emacs
  :custom
  ;; TAB cycle if there are only few candidates
  ;; (completion-cycle-threshold 3)

  ;; Enable indentation+completion using the TAB key.
  ;; `completion-at-point' is often bound to M-TAB.
  (tab-always-indent 'complete)

  ;; Emacs 30 and newer: Disable Ispell completion function.
  ;; Try `cape-dict' as an alternative.
  (text-mode-ispell-word-completion nil)

  ;; Hide commands in M-x which do not apply to the current mode.  Corfu
  ;; commands are hidden, since they are not used via M-x. This setting is
  ;; useful beyond Corfu.
  (read-extended-command-predicate #'command-completion-default-include-p))

#+end_src

** Minibuffer Fix
#+begin_src emacs-lisp :tangle ~/.emacs
(defun stop-using-minibuffer (&optional foo)
  "kill the minibuffer"
  (when (and (>= (recursion-depth) 1)
	     (active-minibuffer-window)
	     (not (eq (selected-window)
		      (active-minibuffer-window)))
	     )
    (abort-recursive-edit)))

(add-hook 'window-selection-change-functions #'stop-using-minibuffer)
(add-hook 'mouse-leave-buffer-hook 'stop-using-minibuffer)
#+end_src

** Platform Check
#+begin_src emacs-lisp :tangle ~/.emacs
(defun current-platform ()
  (interactive)
  (cond
   ((string-equal "Android\n" (shell-command-to-string "uname -o")) "android")
   ((string-equal system-type "windows-nt") "windows")
   ((string-equal system-type "darwin") "mac")
   ((string-equal system-type "gnu/linux") "linux"))
  )
(defcustom im-at-work nil
  "im-at-work can be used to conditionally disable code which may not be suitable for work environments. ChatGPT, copilot, etc"
  :type '(boolean))

(defcustom is-mobile (if (string= system-type "android") t nil)
  "is-mobile can be used to conditionally disable code which may not be suitable for mobile environments."
  :type '(boolean))

(defcustom is-gui nil
  "is-gui can be used to conditionally disable code which may not be suitable for gui environments"
  :type '(boolean))

(defcustom is-guix nil
  "is-guix can be used to conditionally disable code which may not be suitable for guix environments"
  :type '(boolean))

(if (string= "mac" (current-platform))
    (setq im-at-work t))

(if (display-graphic-p)
    (setq is-gui t))

(if (executable-find "guix")
    (setq is-guix t))

(use-package exec-path-from-shell
  :init (exec-path-from-shell-initialize))
#+end_src

** Theme

Leuven Theme and Comic Mono

#+begin_src emacs-lisp :tangle ~/.emacs
(use-package autothemer)

(defvar how-ya-feeling 'burn-my-eyes)

(cond
 ((eq how-ya-feeling 'dark-tbh)
    (use-package cyberpunk-theme)
     (load-theme 'cyberpunk t))
  ((eq how-ya-feeling 'burn-my-eyes)
   (load-theme 'leuven)
    ))

(set-fontset-font t 'emoji '("Noto Emoji" . "iso10646-1") nil 'prepend)

(if (string= "blep" (system-name))
    (set-face-attribute 'default nil :font "Comic Code" :height 120))

(if im-at-work
    (set-face-attribute 'default nil :font "JetBrains Mono" :height 160))
#+end_src

** Global Config

Random global behavior configs

#+begin_src emacs-lisp :tangle ~/.emacs
(setq-default display-line-numbers 'visual
	    display-line-numbers-current-absolute t
	    display-line-numbers-width 4 
	    display-line-numbers-widen t)
(add-hook 'artist-mode-hook (lambda () (setq indent-tabs-mode nil))) ;; Nothing special in artist mode
;; Line Numbers
(global-display-line-numbers-mode) ;; Enable line numbers
(custom-set-variables '(linum-format 'dynamic)) ;; Automatically align line numbers
(setq display-line-numbers-type 'relative)

(global-hl-line-mode) ;; Highlight the current line
(tool-bar-mode -1) ;; Don't show the ugly emacs toolbar
(scroll-bar-mode -1) ;; No scroll bars
(menu-bar-mode -1) ;; No menu bar
(display-time-mode 1) ;; Show a clock in the modeline
(winner-mode 1) ;; Undo recent buffer configurations
(defalias 'yes-or-no-p 'y-or-n-p) ;; Shorten yes and no
(global-subword-mode 1) ;; Makes emacs understand CamelCase words as two words
(setq reb-re-syntax 'string) ;; Emacs re-mode uses string syntax
(setq recentf-auto-cleanup 'never) ;; disable before we start recentf!
(recentf-mode 1) ;; Remember which files I've recently used
(setq backup-directory-alist '(("." . "~/.emacs.d/backups"))) ;;; Move backups
(setq delete-old-versions -1) ;; Never delete backups
(setq version-control t) ;; Honestly... don't remember but I'm sure I want this
(setq vc-make-backup-files t) ;; Also make backup files for version controller files
(setq auto-save-file-name-transforms '((".*" "~/.emacs.d/auto-save-list/" t))) ;; Store autosaves in this folder instead of next to the file
(setq inhibit-startup-screen t) ;; Don't show the starup screen
(setq create-lockfiles nil) ;; I don't work on systems where multiple people are editing the same files with emacs.
(global-so-long-mode 1) ;; Stop trying to syntax highlight absurdly long strings
(global-set-key (kbd "C-s") 'swiper)
(setq visible-bell t)
;; (setq mouse-1-click-follows-link nil) ;; don't accidentally click links
(setq ediff-split-window-function 'split-window-horizontally)
(setq ediff-window-setup-function 'ediff-setup-windows-plain)

(defun my-electric-pair-inhibit-p (c)
  "Inhibit electric pairing for the carat character."
  (if (char-equal c ?<)
      t
    (electric-pair-default-inhibit c)))

(setq electric-pair-inhibit-predicate #'my-electric-pair-inhibit-p)

(use-package expand-region)
#+end_src

** Projectile

Projectile enriches Emacs's ability to understand git projects

#+begin_src emacs-lisp :tangle ~/.emacs
(use-package ag)

(use-package projectile
  :bind (("s-p" . projectile-command-map)
	 ("C-c p" . projectile-command-map))
  :config (projectile-global-mode)
  (setq projectile-current-project-on-switch 'keep)
  (define-key projectile-mode-map (kbd "s-p") 'projectile-command-map)
  (define-key projectile-mode-map (kbd "C-c p") 'projectile-command-map)
  (projectile-mode +1))

(defun noonker/open-all-project-files ()
  (interactive)
  (let ((project-files (projectile-project-files (projectile-project-root))))
    (dolist (file project-files)
      (find-file (expand-file-name file (projectile-project-root))))))
#+end_src

** GPG Config

Emacs can nearly transparently use .gpg encrypted files in emacs. These settings enrich it slightly or make it less effort.

#+begin_src emacs-lisp :tangle ~/.emacs
(if (not im-at-work)
    (setq epa-file-encrypt-to "noonker@gmail.com") ;; Encrypt to my gpg key
)
(setf epg-pinentry-mode 'loopback) ;; No UI popup. Ask for password in modeline
#+end_src

* Tools
* Evil?

Lispy mode makes lisp-mode editing significantly more efficent

#+begin_src emacs-lisp :tangle ~/.emacs
(use-package evil
  :ensure t
  :init
  (setq evil-want-integration t) ;; This is optional since it's already set to t by default.
  (setq evil-want-keybinding nil)
  :config
  ;;  Unsure tbh
  ;;  (setq evil-want-minibuffer t)
  (evil-mode 1)
  (define-key evil-normal-state-map (kbd "C-e") 'move-end-of-line)
  )

(use-package evil-collection
  :after evil
  :ensure t
  :config
  (evil-collection-init))

(use-package evil-surround
  :ensure t
  :config
  (global-evil-surround-mode 1))

(use-package paredit)

(use-package evil-paredit)

(defun hook-the-parenthesis-things ()
  (paredit-mode 1)
  (evil-paredit-mode 1))

(add-hook 'emacs-lisp-mode-hook 'hook-the-parenthesis-things)

(evil-ex-define-cmd "wq" 'save-and-kill-this-buffer)

(defun save-and-kill-this-buffer()
  (interactive)
  (save-buffer)
  (kill-current-buffer))
#+end_src

* Programming
** Eglot
#+begin_src emacs-lisp :tangle ~/.emacs
(use-package eglot
  :ensure t
  :defer t
  :hook ((python-mode . eglot-ensure)
         (go-mode . eglot-ensure))
  :config
  (add-to-list 'eglot-server-programs
               `(python-mode . ("pyright-langserver" "--stdio")
			     )))
#+end_src

** Treesitter
#+begin_src emacs-lisp :tangle ~/.emacs
(setq treesit-language-source-alist
      '((bash "https://github.com/tree-sitter/tree-sitter-bash")
	(cmake "https://github.com/uyha/tree-sitter-cmake")
	(css "https://github.com/tree-sitter/tree-sitter-css")
	(elisp "https://github.com/Wilfred/tree-sitter-elisp")
	(go "https://github.com/tree-sitter/tree-sitter-go")
	(html "https://github.com/tree-sitter/tree-sitter-html")
	(javascript "https://github.com/tree-sitter/tree-sitter-javascript" "master" "src")
	(json "https://github.com/tree-sitter/tree-sitter-json")
	(make "https://github.com/alemuller/tree-sitter-make")
	(markdown "https://github.com/ikatyang/tree-sitter-markdown")
	(python "https://github.com/tree-sitter/tree-sitter-python")
	(toml "https://github.com/tree-sitter/tree-sitter-toml")
	(rust "https://github.com/tree-sitter/tree-sitter-rust")
	(tsx "https://github.com/tree-sitter/tree-sitter-typescript" "master" "tsx/src")
	(typescript "https://github.com/tree-sitter/tree-sitter-typescript" "master" "typescript/src")
	(yaml "https://github.com/ikatyang/tree-sitter-yaml")))
#+end_src

** Guile
#+begin_src emacs-lisp :tangle ~/.emacs
;; Assuming the Guix checkout is in ~/git/guix.
(if is-guix
    (progn
      (with-eval-after-load 'geiser-guile
	(add-to-list 'geiser-guile-load-path "~/git/guix"))
      
      ;; Assuming the Guix checkout is in ~/git/guix.
      ;; Yasnippet configuration
      (with-eval-after-load 'yasnippet
	(add-to-list 'yas-snippet-dirs "~/git/guix/etc/snippets/yas"))
      ;; Tempel configuration
      (with-eval-after-load 'tempel
	;; Ensure tempel-path is a list -- it may also be a string.
	(unless (listp 'tempel-path)
	  (setq tempel-path (list tempel-path)))
	(add-to-list 'tempel-path "~/git/guix/etc/snippets/tempel/*"))
      
      (load-file "~/git/guix/etc/copyright.el")
      ))
#+end_src

** Flycheck

[[https://www.flycheck.org/en/latest/][Flycheck]] is a syntax checker for emacs

#+begin_src emacs-lisp :tangle ~/.emacs
(use-package flycheck
  :config
  (global-flycheck-mode)
  (setq-default flycheck-disabled-checker '(emacs-lisp-checkdoc)))
#+end_src

*** C/C++ / Platformio-DCMAKE_PREFIX_PATH=/usr/local/opt/llvm

On MacOS you need to add =-DCMAKE_PREFIX_PATH=/usr/local/opt/llvm= after =cmake= to run =install-irony-server= per [[https://github.com/Sarcasm/irony-mode/issues/167][this]] git issue.

#+begin_src emacs-lisp :tangle ~/.emacs
(add-hook 'c-mode-hook 'eglot-ensure)
(add-hook 'c++-mode-hook 'eglot-ensure)

(setq gc-cons-threshold (* 100 1024 1024)
      read-process-output-max (* 1024 1024)
      treemacs-space-between-root-nodes nil
      company-minimum-prefix-length 1)

(use-package irony)
(add-hook 'c++-mode-hook 'irony-mode)
(add-hook 'c-mode-hook 'irony-mode)
(add-hook 'objc-mode-hook 'irony-mode)
(add-hook 'irony-mode-hook 'irony-cdb-autosetup-compile-options)
(add-to-list 'company-backends 'company-irony) ;; Add the required company backend.

;; Enable irony for all c++ files, and platformio-mode only
;; when needed (platformio.ini present in project root).
(add-hook 'c++-mode-hook (lambda ()
			   (irony-mode)
			   (irony-eldoc)
			   (platformio-conditionally-enable)))

;; Use irony's completion functions.
(add-hook 'irony-mode-hook
	  (lambda ()
	    (define-key irony-mode-map [remap completion-at-point]
			'irony-completion-at-point-async)

	    (define-key irony-mode-map [remap complete-symbol]
			'irony-completion-at-point-async)

	    (irony-cdb-autosetup-compile-options)))

;; Setup irony for flycheck.
;;  (add-hook 'flycheck-mode-hook 'flycheck-irony-setup)

(use-package ggtags)
(add-hook 'c-mode-common-hook
	  (lambda ()
	    (when (derived-mode-p 'c-mode 'c++-mode 'java-mode 'asm-mode)
	      (ggtags-mode 1))))

(define-key ggtags-mode-map (kbd "C-c g s") 'ggtags-find-other-symbol)
(define-key ggtags-mode-map (kbd "C-c g h") 'ggtags-view-tag-history)
(define-key ggtags-mode-map (kbd "C-c g r") 'ggtags-find-reference)
(define-key ggtags-mode-map (kbd "C-c g f") 'ggtags-find-file)
(define-key ggtags-mode-map (kbd "C-c g c") 'ggtags-create-tags)
(define-key ggtags-mode-map (kbd "C-c g u") 'ggtags-update-tags)

(define-key ggtags-mode-map (kbd "M-,") 'pop-tag-mark)

(setq-local imenu-create-index-function #'ggtags-build-imenu-index)

(add-to-list 'company-backends 'company-c-headers)
(setq wdired-allow-to-change-permissions t)
#+end_src

** Rust
#+begin_src emacs-lisp :tangle ~/.emacs
(use-package rustic
  :ensure
  :bind (:map rustic-mode-map
              ("C-c C-c l" . flycheck-list-errors))
  :config
  ;; uncomment for less flashiness
  ;; (setq lsp-eldoc-hook nil)
  ;; (setq lsp-enable-symbol-highlighting nil)
  ;; (setq lsp-signature-auto-activate nil)

  ;; comment to disable rustfmt on save
  (setq rustic-format-on-save t)
  (add-hook 'rustic-mode-hook 'rk/rustic-mode-hook))

(defun rk/rustic-mode-hook ()
  ;; so that run C-c C-c C-r works without having to confirm, but don't try to
  ;; save rust buffers that are not file visiting. Once
  ;; https://github.com/brotzeit/rustic/issues/253 has been resolved this should
  ;; no longer be necessary.
  (when buffer-file-name
    (setq-local buffer-save-without-query t)))
#+end_src

** Go
#+begin_src emacs-lisp :tangle ~/.emacs
(use-package go-mode)

(add-hook 'go-mode-hook 'eglot-ensure)
(add-hook 'go-mode-hook 'subword-mode)
(add-hook 'before-save-hook 'gofmt-before-save)

(add-hook 'go-mode-hook (lambda ()
                          (setq tab-width 4)
                          (flycheck-add-next-checker 'go 'go-vet)
                          (flycheck-add-next-checker 'go 'go-staticcheck)))
#+end_src

** Python

#+begin_src emacs-lisp :tangle ~/.emacs
(use-package envrc
  :hook (after-init . envrc-global-mode))

(use-package python
  :bind (("C-c C-c" . python-shell-send-region)))

(add-hook 'python-mode-hook 'electric-pair-mode)

(use-package elpy
  :ensure t
  :init
  (elpy-enable)
  (pyvenv-tracking-mode)
  (setq elpy-rpc-virtualenv-path 'current)
  ;; (setq elpy-shell-starting-directory 'current-directory) ;; default is 'project-root 
  (setenv "WORKON_HOME" (file-name-concat (file-truename "~") ".virtualenvs"))
  (setq elpy-shell-echo-output nil)
  (setq python-shell-interpreter "python"))
(add-hook 'elpy-mode-hook (lambda ()
                            (add-hook 'before-save-hook
                                      'elpy-black-fix-code nil t)))

(defvar noonker/python-binary-for-venvs "/Library/Frameworks/Python.framework/Versions/3.10/bin/python3")

(defun noonker/create-python-project-environment ()
  "Create a Python virtual environment and set up project configuration files."
  (interactive)
  ;; Query for venv name
  (let* ((venv-name (read-string "Virtual environment name: "))
         (project-root (projectile-project-root))
         (dir-locals-path (expand-file-name ".dir-locals.el" project-root))
         (envrc-path (expand-file-name ".envrc" project-root)))
    
    ;; Create the virtualenv
    (pyvenv-create venv-name noonker/python-binary-for-venvs)
    
    ;; Create .dir-locals.el file
    (with-temp-file dir-locals-path
      (insert (format "(
 (nil . ((pyvenv-workon . \"%s\")))
)" venv-name)))
    
    ;; Create .envrc file
    (with-temp-file envrc-path
      (insert (format "echo \"Activating %s venv\"
source ~/.virtualenvs/%s/bin/activate
export BASEPATH=%s
export PYTHONPATH=%s
" venv-name venv-name project-root project-root)))
    
(message "Python environment '%s' created with supporting files" venv-name)))
#+end_src

** Platformio

Platformio is for programming embedded devices

#+begin_src emacs-lisp :tangle ~/.emacs
(use-package platformio-mode)
#+end_src

** Typescript

Typescript

#+begin_src emacs-lisp :tangle ~/.emacs
(use-package rjsx-mode)

(use-package typescript-mode)

(use-package tide
  :ensure t
  :after (typescript-mode flycheck)
  :hook ((typescript-mode . tide-setup)
	 (typescript-mode . tide-hl-identifier-mode)
	 ;; (before-save . tide-format-before-save)
	 ))
#+end_src

** Clojure

Clojure

#+begin_src emacs-lisp :tangle ~/.emacs
(use-package clj-refactor)

(if (not is-mobile)
  (add-hook 'clojure-mode-hook 'eglot-ensure)
  (add-hook 'clojurescript-mode-hook 'eglot-ensure)
  (add-hook 'clojurec-mode-hook 'eglot-ensure))

(setq gc-cons-threshold (* 100 1024 1024)
      read-process-output-max (* 1024 1024)
      treemacs-space-between-root-nodes nil
      company-minimum-prefix-length 1
      )

(use-package clojure-mode
  :ensure t
  :mode (("\\.clj\\'" . clojure-mode)
	 ("\\.edn\\'" . clojure-mode)
	 ))

(use-package cider
  :ensure t
  :defer t
  :init (add-hook 'cider-mode-hook #'clj-refactor-mode)
  :diminish subword-mode
  :config
  (setq nrepl-log-messages t
	cider-repl-display-in-current-window t
	cider-repl-use-clojure-font-lock t
	cider-prompt-save-file-on-load 'always-save
	cider-font-lock-dynamically '(macro core function var)
	nrepl-hide-special-buffers t
	cider-overlays-use-font-lock t)
  (cider-repl-toggle-pretty-printing))



(add-hook 'clojure-mode-hook #'paredit-mode)
(add-hook 'clojure-mode-hook #'subword-mode)
(add-hook 'clojure-mode-hook #'eldoc-mode)
(add-hook 'clojure-mode-hook (lambda ()
                            (add-hook 'before-save-hook
                                      'cider-format-buffer nil t)))

#+end_src

** Json
#+begin_src emacs-lisp :tangle ~/.emacs
(use-package json)
(use-package json-mode)
(use-package counsel-jq) ;; Query json file with jq + counsel
#+end_src

** Yaml
#+begin_src emacs-lisp :tangle ~/.emacs
(use-package yaml)
#+end_src

** RMSBolt
#+begin_src emacs-lisp :tangle ~/.emacs
(use-package rmsbolt)
#+end_src
** Passwords 

#+begin_src emacs-lisp :tangle ~/.emacs
(use-package pass
  :config (global-set-key (kbd "<f12>") 'password-store-copy)) ;; Password Store

(defalias 'original-password-store-get (symbol-function 'password-store-get))

(defun noonker/simple-password (&optional prefix-len)
  (interactive "P")
  (let ((len (if prefix-len prefix-len 10)))
  (kill-new
   (shell-command-to-string
    (concat "tr -dc \'A-Za-z0-9!?%=\' < /dev/urandom | head -c "
	    (number-to-string len))))))
#+end_src

** Shell

Emacs shell settings

#+begin_src emacs-lisp :tangle ~/.emacs
;; https://timmydouglas.com/2020/12/17/eshell-counsel.html
(defun timmy/counsel-eshell-history-action (cmd)
  "Insert cmd into the buffer"
  (interactive)
  (insert cmd))

(defun timmy/counsel-eshell-history (&optional initial-input)
  "Find command from eshell history.
INITIAL-INPUT can be given as the initial minibuffer input."
  (interactive)
    (ivy-read "Find cmd: " (timmy/eshell-history-list)
              :initial-input initial-input
              :action #'timmy/counsel-eshell-history-action
              :caller 'timmy/counsel-eshell-history))

(defun timmy/eshell-history-list ()
  "return the eshell history as a list"
  (and (or (not (ring-p eshell-history-ring))
	   (ring-empty-p eshell-history-ring))
       (error "No history"))
  (let* ((index (1- (ring-length eshell-history-ring)))
	 (ref (- (ring-length eshell-history-ring) index))
	 (items (list)))
    (while (>= index 0)
      (setq items (cons (format "%s" (eshell-get-history index)) items)
	    index (1- index)
	    ref (1+ ref)))
    items))
;; end

(use-package eshell-git-prompt)

(use-package eshell
  :bind (("C-c e" . counsel-esh-history)
	 ("C-<tab>" . yas-expand-from-trigger-key)
	 ("C-r" . timmy/counsel-eshell-history)
	 ))

(add-hook 'eshell-mode-hook
          (lambda ()
            (progn
	      (evil-local-set-key 'normal (kbd "gr") #'timmy/counsel-eshell-history)
	      (evil-local-set-key 'insert (kbd "C-r") #'timmy/counsel-eshell-history))))

;; For updating VENV information based on .dir-locals.el
(add-hook 'eshell-directory-change-hook
	  (lambda ()
	    (progn
	      (hack-local-variables))))

(eshell-git-prompt-use-theme 'robbyrussell) ;; Eshell theme

(setq eshell-error-if-no-glob t
      eshell-hist-ignoredups t
      eshell-save-history-on-exit t
      eshell-prefer-lisp-functions nil
      eshell-destroy-buffer-when-process-dies t)

(defun git-prompt-eshell ()
  "Git a git prompt"
  (let (beg dir git-branch git-dirty end)
    (if (eshell-git-prompt--git-root-dir)
      	(progn
      	  (setq eshell-git-prompt-branch-name (eshell-git-prompt--branch-name))
      	  (setq git-branch
      		(concat
      		 (with-face "git:(" 'eshell-git-prompt-robyrussell-git-face)
      		 (with-face (eshell-git-prompt--readable-branch-name) 'eshell-git-prompt-robyrussell-branch-face)
      		 (with-face ")" 'eshell-git-prompt-robyrussell-git-face)))
      	  (setq git-dirty
      		(when (eshell-git-prompt--collect-status)
      		  (with-face "ü´†" 'eshell-git-prompt-robyrussell-git-dirty-face)))
      	  (concat git-branch git-dirty)) "ü§ö" )))

(setq eshell-prompt-function
      (lambda ()
      	(concat
      	 (propertize "‚îå‚îÄ[" 'face 'org-level-4)
      	 (propertize (user-login-name) 'face 'bold)
      	 (propertize "@" 'face 'org-level-4)
      	 (if (is-tramp-window)
      	     (propertize (file-remote-p default-directory) 'face 'bold)
      	   (propertize (system-name) 'face 'bold))
      	 (propertize "]‚îÄ‚îÄ[" 'face 'org-level-4)
      	 (propertize (format-time-string "%H:%M" (current-time)) 'face 'cursor)
      	 (propertize "]‚îÄ‚îÄ[" 'face 'org-level-4)
      	 (propertize (concat (eshell/pwd)) 'face 'bold)
      	 (propertize "]‚îÄ‚îÄ[" 'face 'org-level-4)
      	 (if (is-tramp-window) "üåé"
      	   (concat (propertize (git-prompt-eshell) 'face 'org-level-6)
      		   (if pyvenv-virtual-env-name (concat (propertize "]‚îÄ‚îÄ[" 'face 'org-level-4)
      						       (propertize (format "venv:%s" pyvenv-virtual-env-name) 'face 'org-level-2)))))
      	 (propertize "]\n" 'face 'org-level-4)
      	 (propertize "‚îî‚îÄ>" 'face 'org-level-4)
      	 (propertize (if (= (user-uid) 0) " # " " $ ") 'face 'default)
	 )))

(setq eshell-visual-commands '("htop" "vi" "screen" "top" "less"
      			       "more" "lynx" "ncftp" "pine" "tin" "trn" "elm"
      			       "vim" "mitmproxy" "aider" "r2" "ssh"))

(setq eshell-visual-subcommands '())
(add-to-list 'eshell-visual-subcommands '("git" "log" "diff" "show"))
(add-to-list 'eshell-visual-subcommands '("docker" "build"))

(setenv "PAGER" "cat")

(defalias 'ff 'find-file)
(defalias 'd 'dired)

(defun eshell/clear ()
  (let ((inhibit-read-only t))
    (erase-buffer)))

(defun eshell/gst (&rest args)
  (magit-status (pop args) nil)
  (eshell/echo))   ;; The echo command suppresses output

(use-package esh-autosuggest
  :hook (eshell-mode . esh-autosuggest-mode)
  ;; If you have use-package-hook-name-suffix set to nil, uncomment and use the
  ;; line below instead:
  ;; :hook (eshell-mode-hook . esh-autosuggest-mode)
  :ensure t)
#+end_src

** Tramp

Tramp allows for nearly transparent editing of files on remote machines. Run =C-x C-f= and preface your url with =/ssh:user@host:= to connect to a remote hose and select a file.

#+begin_src emacs-lisp :tangle ~/.emacs
;;; no vc in tramp
(require 'tramp)

(if (not im-at-work)
    (add-to-list 'tramp-remote-path 'tramp-own-remote-path))

(setq remote-file-name-inhibit-cache nil)
(setq vc-ignore-dir-regexp
      (format "\\(%s\\)\\|\\(%s\\)"
	      vc-ignore-dir-regexp
	      tramp-file-name-regexp))
(setq tramp-verbose 1)
(defadvice projectile-on (around exlude-tramp activate)
  "This should disable projectile when visiting a remote file"
  (unless  (--any? (and it (file-remote-p it))
		   (list
		    (buffer-file-name)
		    list-buffers-directory
		    default-directory
		    dired-directory))
    ad-do-it))

(setq projectile-mode-line "Projectile")

;; By default lets be safe in tramp
;; (add-hook
;;  'find-file-hook
;;  (lambda ()
;;    (when (file-remote-p default-directory)
;;      (read-only-mode t))))

;; Some more optimizations?
(setq projectile-auto-update-cache nil)
(setq projectile-dynamic-mode-line nil)
#+end_src

** Dired

#+begin_src emacs-lisp  :tangle ~/.emacs
(use-package dired-preview)
(define-key dired-mode-map (kbd "[") 'dired-preview-mode)
(define-key dired-mode-map (kbd "]") 'image-dired) 

(with-eval-after-load 'dired
  (require 'dired-x)
  ;; Set dired-x global variables here.  For example:
  ;; (setq dired-x-hands-off-my-keys nil)
  )

(setq dired-dwim-target t) ;; When moving a file assume I want to move it to the other dired buffer first
(setq dired-mouse-drag-files t) ;; Drag files from dired emacs

(define-key dired-mode-map (kbd "}") 'wdired-change-to-wdired-mode)
(define-key dired-mode-map (kbd "{") 'find-name-dired)  ;; Quick Search
#+end_src

** SomaFM

Drone Zone >>> All Else

#+begin_src emacs-lisp :tangle ~/.emacs
(use-package somafm)
#+end_src

** ERC

IRC for Emacs

#+begin_src emacs-lisp :tangle ~/.emacs
(use-package erc
  :config
  (setq erc-hide-list '("JOIN" "PART" "QUIT")))

(use-package erc-colorize
  :config
  (erc-colorize-mode 1))

(defun libera ()
  "Connect to IRC"
  (interactive)
  (erc-ssl :server "192.168.50.228" :port "6669" :nick "noonker" :password
	   (format "noonker/libera:%s" (password-store-get "Internet/ZNC")) )
  )

(defun nerds ()
  (interactive)
  (erc-ssl :server "192.168.50.228" :port "6669" :nick "noonker" :password
	   (format "noonker/nerds:%s" (password-store-get "Internet/ZNC"))))

(setq erc-rename-buffers t)
#+end_src

** Elfeed

[[https://github.com/skeeto/elfeed][Elfeed]] is an emacs RSS feed reader. I've blogged about features [[https://noonker.github.io/posts/2020-04-22-elfeed/][here]].

#+begin_src emacs-lisp :tangle ~/.emacs
(use-package elfeed
  :bind (:map elfeed-search-mode-map
	      ("m" . elfeed-mail-todo)
	      ("v" . elfeed-mpv-open)
	      ("t" . elfeed-w3m-open)
	      ("w" . elfeed-eww-open)
	      ("f" . elfeed-firefox-open)
	      ("o" . elfeed-org-open)
	      ("d" . elfeed-youtube-dl)
	      ("a" . elfeed-termux-open)
	      )

  :config
  (defun elfeed-mail-todo (&optional use-generic-p)
    "Mail this to myself for later reading"
    (interactive "P")
    (let ((entries (elfeed-search-selected)))
      (cl-loop for entry in entries
	       do (elfeed-untag entry 'unread)
	       when (elfeed-entry-title entry)
	       do (todo it (elfeed-entry-link entry)))
      (mapc #'elfeed-search-update-entry entries)
      (unless (use-region-p) (forward-line))))

  (defun elfeed-mpv-open (&optional use-generic-p)
    (interactive "P")
    (let ((entries (elfeed-search-selected)))
      (cl-loop for entry in entries
	       do (elfeed-untag entry 'unread)
	       when (caar (elfeed-entry-enclosures entry))
	       do (async-shell-command (format "echo \"%s\" && mpv \"%s\"" it it)
				       (format "*elfeed-mpv: %s*" it)))
      (mapc #'elfeed-search-update-entry entries)
      (unless (use-region-p) (forward-line)))
    )

  (defun elfeed-eww-open (&optional use-generic-p)
    "open with eww"
    (interactive "P")
    (let ((entries (elfeed-search-selected)))
      (cl-loop for entry in entries
	       do (elfeed-untag entry 'unread)
	       when (elfeed-entry-link entry)
	       do (eww-browse-url it))
      (mapc #'elfeed-search-update-entry entries)
      (unless (use-region-p) (forward-line))))

  (defun elfeed-firefox-open (&optional use-generic-p)
    "open with firefox"
    (interactive "P")
    (let ((entries (elfeed-search-selected)))
      (cl-loop for entry in entries
	       do (elfeed-untag entry 'unread)
	       when (elfeed-entry-link entry)
	       do (browse-url-firefox it))
      (mapc #'elfeed-search-update-entry entries)
      (unless (use-region-p) (forward-line))))

  (defun elfeed-youtube-dl (&optional use-generic-p)
    "youtube-dl"
    (interactive "P")
    (let ((entries (elfeed-search-selected)))
      (cl-loop for entry in entries
	       do (elfeed-untag entry 'unread)
	       when (elfeed-entry-link entry)
	       do (yt-dl-it it))
      (mapc #'elfeed-search-update-entry entries)
      (unless (use-region-p) (forward-line))))

  (defun elfeed-org-open (&optional use-generic-p)
    "open with org-web-tools"
    (interactive "P")
    (let ((entries (elfeed-search-selected)))
      (cl-loop for entry in entries
	       do (elfeed-untag entry 'unread)
	       when (elfeed-entry-link entry)
	       do (org-web-tools-read-url-as-org it))
      (mapc #'elfeed-search-update-entry entries)
      (unless (use-region-p) (forward-line))))
  )
#+end_src

*Elfeed Youtube*

#+begin_src emacs-lisp :tangle ~/.emacs
(use-package elfeed-tube
  :ensure t ;; or :straight t
  :after elfeed
  :demand t
  :config
  ;; (setq elfeed-tube-auto-save-p nil) ; default value
  (setq elfeed-tube-auto-fetch-p t)  ; default value
  (elfeed-tube-setup)

  :bind (:map elfeed-show-mode-map
         ("F" . elfeed-tube-fetch)
         ([remap save-buffer] . elfeed-tube-save)
         :map elfeed-search-mode-map
         ("F" . elfeed-tube-fetch)
         ([remap save-buffer] . elfeed-tube-save)))

(use-package elfeed-tube-mpv
  :ensure t ;; or :straight t
  :bind (:map elfeed-show-mode-map
              ("C-c C-f" . elfeed-tube-mpv-follow-mode)
              ("C-c C-w" . elfeed-tube-mpv-where)))
#+end_src

** Gnus

#+begin_src emacs-lisp :tangle ~/.emacs
(if (not im-at-work) 
    (progn
      (setq user-mail-address "noonker@pm.me"
	    user-full-name  "Joshua Person")

      (setq send-mail-function 'smtpmail-send-it
	    starttls-use-gnutls t
	    smtpmail-smtp-server "127.0.0.1"
	    smtpmail-smtp-service 1025
	    smtpmail-auth-credentials "~/.authinfo.gpg"
	    smtpmail-stream-type 'starttls
	    smtpmail-smtp-user "noonker@pm.me")

      (setq gnus-select-method '(nnimap "protonmail"
					(nnimap-address "127.0.0.1")
					(nnimap-server-port 1143)
 					(nnimap-inbox "INBOX")
					(nnimap-subscribed-newsgroups ("nnimap+protonmail:INBOX"))
					(nnimap-stream starttls)
					(nnimap-authinfo-file "~/.authinfo.gpg")))))
;; (setq gnus-check-new-newsgroups nil)
#+end_src

Email client for emacs

#+begin_src emacs-lisp :tangle ~/.emacs
(use-package org-msg)
(setq mail-user-agent 'gnus-user-agent)
(require 'org-msg)
(setq org-msg-options "html-postamble:nil H:5 num:nil ^:{} toc:nil author:nil email:nil \\n:t"
      org-msg-startup "hidestars indent inlineimages"
      org-msg-greeting-fmt "\nHello,\n\n"
      org-msg-greeting-name-limit 3
      org-msg-default-alternatives '((new		. (text html))
  				     (reply-to-html	. (text html))
  				     (reply-to-text	. (text)))
      org-msg-convert-citation t
      org-msg-signature "
Joshua ‚úåÔ∏è
This message was composed without the use of AI I respect our shared humanity")
(org-msg-mode)
#+end_src

** Emacs Lisp Packages

These are emacs-lisp packages that I use often enough in scratch-buffers
that I'm requiring them outside of a package

#+begin_src emacs-lisp :tangle ~/.emacs
(use-package ov)
(use-package request)
(use-package cl-lib)
#+end_src

** PCRE2EL

#+begin_src emacs-lisp :tangle ~/.emacs
(use-package pcre2el)
#+end_src

** Mobile

Functions and mobile gadgets

#+begin_src emacs-lisp :tangle ~/.emacs
(defun copy-app-to-desktop (bundle-id)
  (let ((command (format "adb pull $(adb shell pm path %s | cut -d \":\" -f2 | head -n1 ) %s/%s.apk" bundle-id "$HOME/Desktop/" bundle-id)))
    (shell-command command)
    )
  )

(defun start-iproxy ()
  (interactive)
  (async-shell-command "iproxy 2222 22" "*iproxy*"))

(defun iphone-screenshot ()
  (interactive)
  (let  ((screenshot-name (nth 3 (split-string
				  (shell-command-to-string "cd /tmp/ && idevicescreenshot")))))
    (find-file (format "/tmp/%s" screenshot-name))
    )
  )

(defun get-android-apk ()
  (interactive)
  (copy-app-to-desktop
   (completing-read
    "Copy App: "
    (split-string (shell-command-to-string "adb shell pm list packages -3 | sed \"s/package://g\"")))))

(defun start-simulator ()
  (interactive)
  (let ((udid nil)
	(sim-option (completing-read
		     "Start Simulator: "
		     (split-string (shell-command-to-string "xcrun simctl list | grep Shutdown") "\n"))))
    (and (string-match "\\([0-9a-fA-F]\\{8\\}-[0-9a-fA-F]\\{4\\}-[0-9a-fA-F]\\{4\\}-[0-9a-fA-F]\\{4\\}-[0-9a-fA-F]\\{12\\}\\)" sim-option)
	 (setq udid (match-string 1 sim-option)))
    (if udid
	(shell-command (format "open -a Simulator --args -CurrentDeviceUDID %s" udid)))))

(defun android-start-emulator ()
  (interactive)
  
  (let ((avd (completing-read
	      "Emulator: "
	      (split-string
	       (shell-command-to-string "$HOME/Library/Android/sdk/emulator/emulator -list-avds") "\n"))))
    (if avd
	(shell-command (format "$HOME/Library/Android/sdk/emulator/emulator -avd %s -netdelay none -netspeed full -no-snapshot-load&" avd)))
    ))

(defun get-android-view ()
  (interactive)
  (let ((buffer-name "*ui-dump*"))
    (with-current-buffer (get-buffer-create buffer-name)
      (erase-buffer)
      (shell-command "adb shell uiautomator dump")
      (insert (shell-command-to-string "adb shell cat /sdcard/window_dump.xml"))
      (xml-mode)
      (sgml-pretty-print (point-min) (point-max))
      (switch-to-buffer buffer-name)
      )))
#+end_src

** Magit

Magit is git porcelain for Emacs

#+begin_src emacs-lisp :tangle ~/.emacs
(use-package magit
  :config
  (global-set-key (kbd "C-x g") 'magit-status)
  (setq magit-save-repository-buffers nil))
#+end_src

** Counsel
#+begin_src emacs-lisp :tangle ~/.emacs
(use-package counsel)
#+end_src

** Kubernetes

#+begin_src emacs-lisp :tangle ~/.emacs
(use-package kubel)
#+end_src

* PDF
** PDF Tools
#+begin_src emacs-lisp :tangle ~/.emacs
(if (not is-mobile)
    (progn
      (use-package pdf-tools
	:straight t
	:config
	(pdf-tools-install))
      (add-hook 'pdf-view-mode-hook (lambda () (progn (display-line-numbers-mode -1))))
      ))
#+end_src

** \LaTeX
#+begin_src emacs-lisp :tangle ~/.emacs
(use-package tex
  :straight auctex)

;; CDLatex settings
(use-package cdlatex
  :ensure t
  :hook (LaTeX-mode . turn-on-cdlatex)
  :bind (:map cdlatex-mode-map 
              ("<tab>" . cdlatex-tab)))

;; Yasnippet settings
(use-package yasnippet
  :ensure t
  :hook ((LaTeX-mode . yas-minor-mode)
         (post-self-insert . my/yas-try-expanding-auto-snippets))
  :config
  (use-package warnings
    :config
    (cl-pushnew '(yasnippet backquote-change)
                warning-suppress-types
                :test 'equal))

  (setq yas-triggers-in-field t)

  (add-to-list 'yas-snippet-dirs (file-name-concat "~/git" "dotfiles/snippets"))
  
  ;; Function that tries to autoexpand YaSnippets
  ;; The double quoting is NOT a typo!
  (defun my/yas-try-expanding-auto-snippets ()
    (when (and (boundp 'yas-minor-mode) yas-minor-mode)
      (let ((yas-buffer-local-condition ''(require-snippet-condition . auto)))
        (yas-expand)))))

(use-package yasnippet-snippets)

(yas-global-mode)

(yas-reload-all)

;; CDLatex integration with YaSnippet: Allow cdlatex tab to work inside Yas
;; fields
(use-package cdlatex
  :hook ((cdlatex-tab . yas-expand)
         (cdlatex-tab . cdlatex-in-yas-field))
  :config
  (use-package yasnippet
    :bind (:map yas-keymap
		("<tab>" . yas-next-field-or-cdlatex)
		("TAB" . yas-next-field-or-cdlatex))
    :config
    (defun cdlatex-in-yas-field ()
      ;; Check if we're at the end of the Yas field
      (when-let* ((_ (overlayp yas--active-field-overlay))
                  (end (overlay-end yas--active-field-overlay)))
        (if (>= (point) end)
            ;; Call yas-next-field if cdlatex can't expand here
            (let ((s (thing-at-point 'sexp)))
              (unless (and s (assoc (substring-no-properties s)
                                    cdlatex-command-alist-comb))
                (yas-next-field-or-maybe-expand)
                t))
          ;; otherwise expand and jump to the correct location
          (let (cdlatex-tab-hook minp)
            (setq minp
                  (min (save-excursion (cdlatex-tab)
                                       (point))
                       (overlay-end yas--active-field-overlay)))
            (goto-char minp) t))))

    (defun yas-next-field-or-cdlatex nil
      (interactive)
      "Jump to the next Yas field correctly with cdlatex active."
      (if
          (or (bound-and-true-p cdlatex-mode)
              (bound-and-true-p org-cdlatex-mode))
          (cdlatex-tab)
        (yas-next-field-or-maybe-expand)))))

(use-package latex-preview-pane)

(with-eval-after-load 'org
  (progn
    (add-to-list 'org-latex-packages-alist '("" "tcolorbox" t))
    (add-to-list 'org-latex-packages-alist '("" "minted" t))
    (add-to-list 'org-latex-packages-alist '("" "lipsum" t))))

(setq org-preview-latex-default-process 'imagemagick)

(use-package org-contrib
  :config (require 'ox-extra)
  (ox-extras-activate '(ignore-headlines)))

;; For desktop, a 2.0 scaling is appropriate
(if (not is-mobile)
    (setq org-format-latex-options (plist-put org-format-latex-options :scale 2.0)))

(evil-define-key 'normal org-mode-map "gjl" 'org-latex-preview)
#+end_src

* Org Mode
*** Verb
#+begin_src emacs-lisp :tangle ~/.emacs
(use-package verb)
#+end_src

*** Org One Liners
#+begin_src emacs-lisp :tangle ~/.emacs
(setq org-fontify-whole-heading-line t)
(setq org-startup-folded t)
(setq org-ellipsis "üëá")

;; If org-mode gets jumpy from non-monospace fonts
;; (add-hook 'org-mode-hook (lambda () (display-line-numbers-mode -1)))

(setq org-directory "~/org")
(setq org-agenda-basedir "~/org/tasks")

(setq org-startup-align-all-tables t) ;; Aligns tables when a file is opened
(setq org-clock-out-switch-to-state "TODO")
(setq org-clock-out-remove-zero-time-clocks nil)
(setq org-startup-indented t) ;; Indent content of blocks to visual indent
(setq org-edit-src-content-indentation 0)
(eval-after-load 'org
  (add-hook 'org-babel-after-execute-hook 'org-redisplay-inline-images))
(setq org-startup-with-inline-images t)

(use-package hl-todo)
(setq org-src-fontify-natively t)

(defun refile-to-today ()
  "Refile current heading to Today.org/Today without prompting"
  (interactive)
  (let ((pos (save-window-excursion
               (find-file "Today.org")
               (org-find-exact-headline-in-buffer "Today"))))
    (org-refile nil nil (list "Today" "Today.org" nil pos))))

(global-set-key (kbd "C-c a") 'org-agenda)
(global-set-key (kbd "C-c n n") 'org-capture)
(global-set-key (kbd "C-c n c") 'refile-to-today)
(global-set-key (kbd "C-c n r n") 'org-roam-capture)
(global-set-key (kbd "C-c n r f") 'org-roam-node-find)
(global-set-key (kbd "C-c n r i") 'org-roam-node-insert)


(setq personal/node-types '('ctf
			    'investigation
			    'demo
			    'poetry
			    'music
			    'music-analysis))

(defun org-today-update-day ()
  (interactive)
  (setq org-archive-location (format "%s/archive/%s.org::" org-agenda-basedir (format-time-string "%Y-%m-%d"))))

(org-today-update-day)
#+end_src

*** Org Download
#+begin_src emacs-lisp :tangle ~/.emacs
(use-package org-download
  :init
  (progn
    (setq org-image-actual-width (list 900))))
#+end_src

*** Org Transclusion
#+begin_src emacs-lisp :tangle ~/.emacs
(use-package org-transclusion
  :after org)
#+end_src

*** Org Babel Packages
#+begin_src emacs-lisp :tangle ~/.emacs
(use-package ob-sql-mode)
(use-package ob-typescript)
(use-package ob-markdown)
(use-package mermaid-mode)
(use-package ob-mermaid)
(setq ob-mermaid-cli-path "/opt/homebrew/bin/mmdc")
(use-package ob-d2)
(use-package d2-mode)
(use-package ob-sclang)
(straight-use-package
 '(ob-gptel :type git :host github :repo "jwiegley/ob-gptel"))

(defvar d2-mode-map
  (let ((map (make-sparse-keymap)))
    (define-key map (kbd "C-c C-c") 'd2-compile)
    (define-key map (kbd "C-c C-f") 'd2-compile-file)
    (define-key map (kbd "C-c C-b") 'd2-compile-buffer)
    (define-key map (kbd "C-c C-r") 'd2-compile-region)
    (define-key map (kbd "C-c C-h") 'd2-compile-file-and-browse)
    (define-key map (kbd "C-c C-j") 'd2-compile-buffer-and-browse)
    (define-key map (kbd "C-c C-k") 'd2-compile-region-and-browse)
    (define-key map (kbd "C-c C-o") 'd2-open-browser)
    (define-key map (kbd "C-x C-o") 'd2-view-current-svg)
    (define-key map (kbd "C-c C-d") 'd2-open-doc)
    map))
#+end_src

*** Org Babel
#+begin_src emacs-lisp :tangle ~/.emacs
(org-babel-do-load-languages
 'org-babel-load-languages
 '((dot . t)
   (python . t)
   (verb . t)
   (mermaid . t)
   (shell . t)
   (sql . t)
   (js . t)
   (sqlite . t)
   (gnuplot . t)
   (typescript . t)
   (latex . t)
   (C . t)
   (org . t)
   (clojure . t)
   (d2 . t)
   (sclang . t)
   (screen . t)
   (lua . t)
   (gptel . t)))

(setq org-babel-clojure-backend 'cider)

(setq org-confirm-babel-evaluate nil)
#+end_src

*** Org Agenda
#+begin_src emacs-lisp :tangle ~/.emacs
(setq org-archive-file-header-format nil)

(defun  org-init-agenda ()
  (interactive)
  (let ((initial '(("backlog.org" nil)
                   ("recurring.org" nil)
                   ("today.org" nil)
                   ("projects" t)
                   ("archive" t)))
        (todostr "#+TODO: TODO STRT | DONE WONTDO"))
    (if (not (file-directory-p org-agenda-basedir))
        (make-directory org-agenda-basedir))

    (dolist (element initial)
      (let ((name  (nth 0 element))
            (isdir (nth 1 element)))
        ;; If the file doesn't exist and not flagged as dir
        (if (and (not isdir)
                 (not (file-directory-p (format "%s/%s" org-agenda-basedir name))))
            (write-region todostr nil (format "%s/%s" org-agenda-basedir name)))

        ;; If the file doesn't exist and is flagged as dir
        (if (and isdir
                 (not (file-directory-p (format "%s/%s" org-agenda-basedir name))))
            (make-directory (format "%s/%s" org-agenda-basedir name)))))))


(setq org-agenda-files (append (list (format "%s/backlog.org" org-agenda-basedir)
                                     (format "%s/recurring.org" org-agenda-basedir)
                                     (format "%s/meetings.org" org-agenda-basedir)
                                     (format "%s/today.org" org-agenda-basedir))
                               (directory-files-recursively (format "%s/projects/" org-agenda-basedir) "^[0-9a-zA-Z\-_]*?\.org$")
                               ))

(setq org-archive-location (format "%s/archive/%s.org::" org-agenda-basedir (format-time-string "%Y-%m-%d")))

(defun org-agenda-new-day ()
  (interactive)
  (with-current-buffer (find-file (format "%s/today.org" org-agenda-basedir))
    (mark-whole-buffer)
    (kill-region (mark) (point))
    (if (= (buffer-size) 0) (insert "#+CREATED: %U\n#+LAST_MODIFIED: %U#+TODO: TODO IN-PROGRESS | DONE WONTDO\n\n* Tasks\n* Thoughts\n")))
  (org-agenda))

(defun org-complex-tasks ()
  (interactive)
  (let ((tasks  (quote ("TODO Create Jira Ticket"
                        "TODO Documentation"
                        "TODO Close Jira Ticket"))))
    (org-end-of-line)
    (insert " [/]")
    (org-insert-heading)
    (org-demote-subtree)
    (insert (car tasks))
    (dolist (element (cdr tasks))
      (org-insert-heading)
      (insert element))))
#+end_src

*** Org Refile
#+begin_src emacs-lisp :tangle ~/.emacs
(defun directory-files-if-exists (dir)
  (if (file-directory-p dir)
      (directory-files dir t)
    ""))

(setq org-blogpost-directory (directory-files-if-exists (format "%s/blog/content/posts" org-directory)))
(setq org-cheatsheet-directory (directory-files-if-exists (format "%s/cheatsheet" org-directory)))
(setq org-notes-directory (directory-files-if-exists (format "%s/notes" org-directory)))
(setq org-refile-use-outline-path t)                  ; Show full paths for refiling
(setq org-outline-path-complete-in-steps nil)         ; Refile in a single go
(setq org-refile-targets '((org-agenda-files :maxlevel . 3)))
(setq org-refile-allow-creating-parent-nodes t)
(setq org-refile-allow-creating-parent-nodes 'confirm)
(setq org-refile-use-outline-path 'file)
#+end_src

*** Org Capture
#+begin_src emacs-lisp :tangle ~/.emacs
(setq org-capture-templates
      `(("b" "Backlog" entry (file+headline (lambda () (format "%s/backlog.org" org-agenda-basedir)) "Backlog")
	 "** TODO %?\n  %i\n  %a")
	("t" "Today" entry (file+olp (lambda () (format "%s/today.org" org-agenda-basedir)) "Tasks" "Uncategorized")
	 "\n** TODO %?\n SCHEDULED: %t")
	("n" "Now" entry (file+headline (lambda () (format "%s/today.org" org-agenda-basedir)) ,(if im-at-work "Today" "Tasks"))
	 "\n** TODO %?\n SCHEDULED: %t" :clock-in t :clock-keep t)
	("i" "Interrupt" entry (file+headline (lambda () (format "%s/today.org" org-agenda-basedir)) ,(if im-at-work "Today" "Tasks"))
	 "\n** TODO %?\n SCHEDULED: %t" :clock-in t :clock-resume t)
	("c" "Cookbook" entry (file "~/org/cookbook.org")
	 "%(org-chef-get-recipe-from-url)"
	 :empty-lines 1)
	("m" "Manual Cookbook" entry (file "~/org/cookbook.org")
	 "* %^{Recipe title: }\n  :PROPERTIES:\n  :source-url:\n  :servings:\n  :prep-time:\n  :cook-time:\n  :ready-in:\n  :END:\n** Ingredients\n   %?\n** Directions\n\n")
	("p" "Protocol" entry (file+headline ,(concat org-directory "notes.org") "Inbox")
	 "* %^{Title}\nSource: %u, %c\n #+BEGIN_QUOTE\n%i\n#+END_QUOTE\n\n\n%?")
	("L" "Protocol Link" entry (file+headline ,(concat org-directory "notes.org") "Inbox")
	 "* %? [[%:link][%(transform-square-brackets-to-round-ones \"%:description\")]]\n")
	("j" "Journal" entry (file+headline (lambda () (format "%s/journal/%s.org.gpg" org-directory (format-time-string "%Y-%m-%d"))) "Journal") "")
	("B" "Blog Post" plain (file (lambda () (format "%s/blog/noonker/content/posts/%s-%s.org" org-directory (format-time-string "%Y-%m-%d") (replace-regexp-in-string " " "-" (downcase (read-string "Name: ")))))) 
	 ,(format "#+title: TITLE\n#+subtitle:\n#+date: %s\n#+tags[]: tech, emacs\n#+draft: false\n\n" (format-time-string "%Y-%m-%d")))
	)
      )

(setq org-roam-capture-templates '(
				   ("n" "notes" plain "%?"
				    :target (file+head "notes/%<%Y%m%d%H%M%S>-${slug}/${slug}.org"
						       "#+title: ${title}\n#+ROAM_ALIAS:\n#+ROAM_TAGS: \n#+CREATED: %U\n#+LAST_MODIFIED: %U\n\n")
				    :unnarrowed t)
				   ("e" "encrypted notes" plain "%?"
				    :target (file+head "notes/%<%Y%m%d%H%M%S>-${slug}/${slug}.org.gpg"
						       "#+title: ${title}\n#+ROAM_ALIAS:\n#+ROAM_TAGS: \n#+CREATED: %U\n#+LAST_MODIFIED: %U\n\n")
				    :unnarrowed t)
				   ))
#+end_src

*** Org Roam
#+begin_src emacs-lisp :tangle ~/.emacs
(setq org-roam-directory "~/org/")
(use-package websocket)

(use-package org-roam-ui
  :after org-roam ;; or :after org
  ;;         normally we'd recommend hooking orui after org-roam, but since org-roam does not have
  ;;         a hookable mode anymore, you're advised to pick something yourself
  ;;         if you don't care about startup time, use
  ;;  :hook (after-init . org-roam-ui-mode)
  :config
  (setq org-roam-ui-sync-theme t
	org-roam-ui-follow t
	org-roam-ui-update-on-save t
	org-roam-ui-open-on-start t
	)
 (org-roam-db-autosync-mode) ;; Automatically update the org roam database 
  )
#+end_src

*** Org Protocol
#+begin_src emacs-lisp :tangle ~/.emacs
(defun transform-square-brackets-to-round-ones(string-to-transform)
  "Transforms [ into ( and ] into ), other chars left unchanged."
  (concat
   (mapcar #'(lambda (c) (if (equal c ?\[) ?\( (if (equal c ?\]) ?\) c))) string-to-transform))
  )

#+end_src

*** Org Packages
#+begin_src emacs-lisp :tangle ~/.emacs
(use-package org-web-tools)
#+end_src

*** Org eXport
#+begin_src emacs-lisp :tangle ~/.emacs
(setq org-export-with-drawers nil)

(setq org-src-fontify-natively t)
(setq org-latex-listings 'minted
      org-latex-pdf-process
      '("pdflatex -shell-escape -interaction nonstopmode -output-directory %o %f"
        "pdflatex -shell-escape -interaction nonstopmode -output-directory %o %f"))

#+end_src

*** Org + Hugo

Blogging with hugo

#+begin_src emacs-lisp :tangle ~/.emacs
(defun replace-regexp-entire-buffer (pattern replacement)
  "Perform regular-expression replacement throughout buffer."
  (interactive
   (let ((args (query-replace-read-args "Replace" t)))
     (setcdr (cdr args) nil)    ; remove third value returned from query---args
     args))
  (save-excursion
    (goto-char (point-min))
    (while (re-search-forward pattern nil t)
      (replace-match replacement))))

(defun blog-cleanup-buffer ()
  (interactive)
  (replace-regexp-entire-buffer "../../static" ""))

(defun blog-push-to-git ()
  (interactive)
  (async-shell-command (format "cd %s/blog/noonker/public/ && git add . && git commit -m \"update\" && git push") "Blog-Update")
  )

(defun insert-blog-tag ()
  (interactive)
  (insert (completing-read "tag: " '("thoughts" "microblogging" "emacs" "tech" "hell" "accordion" "ctf" "security" "tools" "email" "privacy"))))
#+end_src

** Easydraw

#+begin_src emacs-lisp :tangle ~/.emacs
(use-package edraw-org
  :straight (:host github :repo "misohena/el-easydraw" :files ("dist" "*.el"))
  :config (with-eval-after-load 'org
	    (require 'edraw-org)
	    (edraw-org-setup-default)
	    (evil-set-initial-state 'edraw-property-editor-mode 'emacs)
	    ))
#+end_src

** Markdown
#+begin_src emacs-lisp :tangle ~/.emacs
(use-package markdown-mode)
#+end_src

** Flyspell
#+begin_src emacs-lisp :tangle ~/.emacs
(use-package flyspell
  :config
  (setq ispell-program-name "aspell")
  (dolist (hook '(text-mode-hook))
    (add-hook hook (lambda () (flyspell-mode 1))))
  (add-hook 'python-mode-hook
	    (lambda ()
	      (flyspell-prog-mode)
	      ))
  )
#+end_src

* Custom Functions
** Mac Open

Replace spotlight with emacs

#+begin_src emacs-lisp :tangle ~/.emacs
(defun mac-open ()
  "Open a mac application... In Emacs.... why not"
  (interactive)
  (call-process-shell-command
   (format " open /Applications/%s"
	   (completing-read
	    "Mac Open: "
	    (directory-files "/Applications")))))
#+end_src

** Youtube Download

Download vidoes with youtube-dl

#+begin_src emacs-lisp :tangle ~/.emacs
(defun yt-dl-it (url)
  "Downloads the URL in an async shell"
  (let ((default-directory "~/Videos"))
    (async-shell-command (format "yt-dlp %s" url))))
#+end_src

** Image to Text

Use tesseract-ocr to turn an image into text and insert it into this buffer

#+begin_src emacs-lisp :tangle ~/.emacs
(defun image-to-text ()
  (interactive)
  (if buffer-file-name
      (progn
	;; Convert the file to a tif file for tesseract consumption.
	(shell-command (concat "convert " buffer-file-name " -resize 400% -type Grayscale " buffer-file-name ".tif"))
	;; Convert the file from tif to txt using tesseract.
	(shell-command (concat "tesseract -l eng " buffer-file-name ".tif " buffer-file-name))
	;; Delete the tif file artifact.
	(shell-command (concat "rm " buffer-file-name ".tif"))
	;; Open the text file in buffer, this should be the text found in the image converted.
	(find-file (concat buffer-file-name ".txt")))))
#+end_src

** CNC Mode

These functions enable options where you can have one buffer of commands to run and several other open buffers that the commands will be sent to.

#+begin_src emacs-lisp :tangle ~/.emacs
;; cnc-command
(defun visible-buffers ()
  "Definition"
  (interactive)
  (mapcar '(lambda (window) (buffer-name (window-buffer window))) (window-list)))

(defun all-buffers-except-this ()
  "Definition"
  (interactive)
  (delete (buffer-name (current-buffer)) (visible-buffers))
  )

(defun cnc-from-file ()
  "A command to run commands on the other open buffers"
  (interactive)
  (dolist (elt (all-buffers-except-this))
    (comint-send-string elt (format "%s\n" (thing-at-point `line))))
  (next-line)
  t
  )

(defun cnc-prompt (cmd)
  "A command to run commands on the other open buffers"
  (interactive "sCmd: ")
  (dolist (elt (visible-buffers))
    (comint-send-string elt (format "%s\n" cmd)))
  )

(defun split-cnc (number)
  (interactive "N")
  "Function to split windows into one major window and multiple minor ansi-terms"
  (split-window-horizontally)
  (other-window 1)
  (ansi-term "/bin/bash" "cnc")
  (while (> number 1)
    (split-window-vertically)
    (ansi-term "/bin/bash" "cnc")
    (other-window 1)
    (setq number (+ -1 number)))
  (ansi-term "/bin/bash" "cnc")
  (other-window 1)
  (balance-windows))

(global-set-key (kbd "C-c y") `cnc-prompt)
(global-set-key (kbd "C-c C-.") `cnc-from-file)
#+end_src

** Misc

These functions are helpers and should be self explanitory

#+begin_src emacs-lisp :tangle ~/.emacs
(defun is-tramp-window ()
  (if (file-remote-p default-directory) t nil))

(defun no-fonts-pls ()
  (interactive)
  (let ((inhibit-read-only t))
    (set-text-properties (point-min) (point-max) nil)))

(defun what-is-my-ip ()
  (interactive)
  (message "IP: %s"
	   (with-current-buffer (url-retrieve-synchronously "https://api.`ipify.org")
	     (buffer-substring (+ 1 url-http-end-of-headers) (point-max)))))

(defun character-below ()
  (save-excursion
    (next-line)
    (string (char-after (point)))))

(defun replace-below (cur rep bel)
  (interactive)
  (let ((pos 1)
	(tmp))
    (while (< pos (point-max))
      (if (equal cur (string (char-after pos)))
	  (if (equal bel (character-above))
	      (progn (delete-char 1) (insert rep))
	    ))
      (setq pos (+ 1 pos))
      (goto-char pos)
      )))

(defun ruthless-kill ()
  "Kill the line without copying it"
  (interactive)
  (delete-region (point) (line-end-position)))

(global-set-key (kbd "C-x j") 'kill-current-buffer)
(global-set-key (kbd "C-c k") 'ruthless-kill)

(defun insert-current-date ()
  "Insert the current date"
  (interactive)
  (insert (shell-command-to-string "echo -n $(date +%Y-%m-%d)")))

(defun selenium()
  (interactive)
  (save-excursion
    (async-shell-command "java -jar $HOME/Documents/selenium.jar")))

(defun toggle-maximize-buffer ()
  "Maximize buffer"
  (interactive)
  (if (= 1 (length (window-list)))
      (jump-to-register '_)
    (progn
      (set-register '_ (list (current-window-configuration)))
      (delete-other-windows))))

(defun untabify-buffer ()
  (interactive)
  (untabify (point-min) (point-max)))

(defun indent-buffer ()
  (interactive)
  (indent-region (point-min) (point-max)))

(defun cleanup-buffer ()
  "Perform a bunch of operations on the whitespace content of a buffer."
  (interactive)
  (indent-buffer)
  (untabify-buffer)
  (delete-trailing-whitespace))

;; Easy window splitting
(defun split-maj-min (number)
  (interactive "N")
  "Function to split windows into one major window and multiple minor windows"
  (split-window-horizontally)
  (other-window 1)
  (while (> number 1)
    (setq number (+ -1 number))
    (split-window-vertically))
  (balance-windows))

(defun sudo ()
  "Use TRAMP to `sudo' the current buffer"
  (interactive)
  (when buffer-file-name
    (find-alternate-file
     (concat "/sudo:root@localhost:"
	     buffer-file-name))))

(defun proxy (text &optional port)
  (interactive "sHost: ")
  (async-shell-command (format "ssh -D 1337 -C -q -N %s" text) (format "*proxy: %s*" text)))

(defun todo (text &optional body)
  (interactive "sTodo: ")
  (compose-mail-other-window "noonker@pm.me" text)
  (mail-text)
  (if body
      (insert body))
  (message-send-and-exit)
  )

(global-set-key (kbd "C-c C-t") 'todo)

(defun noonker/flatten-category (category)
  (mapcar (lambda (item) (cons (car category) item)) (cadr category)))

(defun noonker/flatten-bookmarks (bookmarks)
  (mapcan 'noonker/flatten-category bookmarks))

(defun noonker/bookmarks-complete (bookmarks)
  (let* ((choice (completing-read
		 "Bookmarks:"
		 (mapcar (lambda (item) (string-join item "	"))
			 (noonker/flatten-bookmarks bookmarks))))
	 (url (nth 2 (split-string choice "	"))))
    (browse-url url)))
#+end_src

* AI
** Gptel
#+begin_src emacs-lisp :tangle ~/.emacs
(use-package gptel
  :straight (:host github :repo "karthink/gptel" :files ("dist" "*.el")))
(use-package gptel-quick
  :straight (:host github :repo "karthink/gptel-quick" :files ("gptel-quick.el")))

;; Popup question
(defvar gptel-lookup--history nil)

(defun gptel-lookup (prompt)
  (interactive (list (read-string "Ask ChatGPT: " nil gptel-lookup--history)))
  (when (string= prompt "") (user-error "A prompt is required."))
  (gptel-request
   prompt
   :callback
   (lambda (response info)
     (if (not response)
         (message "gptel-lookup failed with message: %s" (plist-get info :status))
       (with-current-buffer (get-buffer-create "*gptel-lookup*")
         (let ((inhibit-read-only t))
           (erase-buffer)
           (insert response))
         (special-mode)
         (display-buffer (current-buffer)
                         `((display-buffer-in-side-window)
                           (side . bottom)
                           (window-height . ,#'fit-window-to-buffer))))))))

(defun gptel-debug ()
  (interactive)
  (gptel-request
   (buffer-substring-no-properties (mark) (point))
   :system "Can you explain to me why I am getting the following error?"
   :callback
   (lambda (response info)
     (if (not response)
         (message "gptel-lookup failed with message: %s" (plist-get info :status))
       (with-current-buffer (get-buffer-create "*gptel-lookup*")
         (let ((inhibit-read-only t))
           (erase-buffer)
           (insert response))
         (special-mode)
         (display-buffer (current-buffer)
                         `((display-buffer-in-side-window)
                           (side . bottom)
                           (window-height . ,#'fit-window-to-buffer))))))))


(defun gptel-editor-rewrite-and-replace (bounds &optional directive)
  (interactive
   (list
    (cond
     ((use-region-p) (cons (region-beginning) (region-end)))
     ((derived-mode-p 'text-mode)
      (list (bounds-of-thing-at-point 'sentence)))
     (t (cons (line-beginning-position) (line-end-position))))
    (and current-prefix-arg
         (read-string "ChatGPT Directive: "
                      "You are a prose editor. Rewrite my prompt more professionally."))))
  (gptel-request
   (buffer-substring-no-properties (car bounds) (cdr bounds)) ;the prompt
   :system (or directive "You are a prose editor. Rewrite my prompt more professionally.")
   :buffer (current-buffer)
   :context (cons (set-marker (make-marker) (car bounds))
                  (set-marker (make-marker) (cdr bounds)))
   :callback
   (lambda (response info)
     (if (not response)
         (message "ChatGPT response failed with: %s" (plist-get info :status))
       (let* ((bounds (plist-get info :context))
              (beg (car bounds))
              (end (cdr bounds))
              (buf (plist-get info :buffer)))
         (with-current-buffer buf
           (save-excursion
             (goto-char beg)
             (kill-region beg end)
             (insert response)
             (set-marker beg nil)
             (set-marker end nil)
             (message "Rewrote line. Original line saved to kill-ring."))))))))

(defun gptel-code-rewrite-and-replace (bounds)
  (interactive
   (list
    (cond
     ((use-region-p) (cons (region-beginning) (region-end)))
     ((derived-mode-p 'text-mode)
      (list (bounds-of-thing-at-point 'sentence)))
     (t (cons (line-beginning-position) (line-end-position))))))
  (gptel-request

   (buffer-substring-no-properties (car bounds) (cdr bounds)) ;the prompt
   :system "You are an expert coder. Take the prompt at point and refactor it. Return only the code. No Commentary."
   :buffer (current-buffer)
   :context (cons (set-marker (make-marker) (car bounds))
                  (set-marker (make-marker) (cdr bounds)))
   :callback
   (lambda (response info)
     (if (not response)
         (message "ChatGPT response failed with: %s" (plist-get info :status))
       (let* ((bounds (plist-get info :context))
              (beg (car bounds))
              (end (cdr bounds))
              (buf (plist-get info :buffer)))
         (with-current-buffer buf
           (save-excursion
             (goto-char beg)
             (kill-region beg end)
             (insert response)
             (set-marker beg nil)
             (set-marker end nil)
             (message "Rewrote line. Original line saved to kill-ring."))))))))

(defun noonker/init-ai ()
  (interactive)
  (let ((anthropic (gptel-make-anthropic "Anthropic" 
		     :stream t
		     :key (password-store-get "Internet/anthropic")))
	(chatgpt

	 (gptel-make-openai "ChatGPT"
	   :key (password-store-get "Internet/openai")
	   :stream t
	   :models
	   '((gpt-4o-mini
	      :capabilities (media tool json url)
	      :description "Affordable and intelligent small model for fast, lightweight tasks"
	      :mime-types ("image/jpeg" "image/png" "image/gif" "image/webp"))
	     (gpt-4o
	      :capabilities (media tool json url)
	      :description "High-intelligence flagship model for complex, multi-step tasks"
	      :mime-types ("image/jpeg" "image/png" "image/gif" "image/webp"))))
	 )
	)
    (if (not im-at-work)
	(progn
	  (setq gptel-model 'gpt-4o)
	  (setq gptel-backend chatgpt)
	  (setq org-ai-openai-api-token (password-store-get "Internet/openai"))
	  )
      nil)))

(evil-global-set-key 'normal "gsm" 'gptel-menu)
(evil-global-set-key 'normal "gss" 'gptel-send)
(evil-global-set-key 'normal "gso" 'gptel)
(evil-global-set-key 'normal "gsp" 'gptel-system-prompt)
(evil-global-set-key 'normal "gsc" 'gptel--read-crowdsourced-prompt)

(global-set-key (kbd "C-'") #'gptel-send)
#+end_src

*** Gptel Tools
#+begin_src emacs-lisp :tangle ~/.emacs
(setq gptel-log-level 'debug)

(with-eval-after-load 'gptel
  (gptel-make-tool
   :function (lambda (url)
               (with-current-buffer (url-retrieve-synchronously url)
                 (goto-char (point-min)) (forward-paragraph)
                 (let ((dom (libxml-parse-html-region (point) (point-max))))
                   (run-at-time 0 nil #'kill-buffer (current-buffer))
                   (with-temp-buffer
                     (shr-insert-document dom)
                     (buffer-substring-no-properties (point-min) (point-max))))))
   :name "read_url"
   :description "Fetch and read the contents of a URL"
   :args (list '(:name "url"
                       :type "string"
                       :description "The URL to read"))
   :category "web")

  ;; Run a shell command
  (gptel-make-tool
   :function (lambda (command)
	       (shell-command-to-string command))
   :name "run_shell_command"
   :description "Run a shell command and return the output"
   :args (list '(:name "command"
		       :type "string"
		       :description "The shell command to run"))
   :category "shell")

  
  (gptel-make-tool
   :function (lambda (emailto subject body)
	       (progn
		 (compose-mail-other-window emailto subject)
		 (mail-text)
		 (if body
		     (insert body))
		 (message-send-and-exit)))
   :name "send_email"
   :description "Send an email to a specified address with a subject and body"
   :args (list '(:name "emailto"
		       :type "string"
		       :description "The email address to send the email to")
	       '(:name "subject"
		       :type "string"
		       :description "The subject of the email")
	       '(:name "body"
		       :type "string"
		       :description "The body of the email")
	       )
   :category "web")

  (gptel-make-tool
   :function (lambda (buffer text)
               (with-current-buffer (get-buffer-create buffer)
                 (save-excursion
                   (goto-char (point-max))
                   (insert text)))
               (format "Appended text to buffer %s" buffer))
   :name "append_to_buffer"
   :description "Append text to the an Emacs buffer.  If the buffer does not exist, it will be created."
   :args (list '(:name "buffer"
                       :type "string"
                       :description "The name of the buffer to append text to.")
               '(:name "text"
                       :type "string"
                       :description "The text to append to the buffer."))
   :category "emacs")

  ;; List buffers
  ;; (gptel-make-tool
  ;;  :function (lambda () (buffer-list))
  ;;  :name "list_buffers"
  ;;  :description "List the currently open emacs buffers"
  ;;  :args (list '())
  ;;  :category "emacs")

  ;; ;; Todo, prompt user
  (gptel-make-tool
   :function (lambda (prompt)
               (completing-read prompt '()))
   :name "prompt_user"
   :description "Prompt a user for input to make next decision"
   :args (list '(:name "prompt"
                 :type "string"
                       :description "The text to display in the prompt"))
   :category "emacs")

  ;; Update guix system config
  ;; Config is created from a makefile located at ~/git/dotfiles/guix/Makefile with the argument laptop to rebuild
  (gptel-make-tool
   :function (lambda (config)
	       (let ((default-directory "~/git/dotfiles/guix"))
		 (async-shell-command (format "make %s" config))))
   :name "update_guix_system"
   :description "Update the guix system configuration"
   :args (list '(:name "config"
		       :type "string"
		       :description "The configuration to update. It's always laptop"))
   :category "guix")

  ;; Same as above, but make home
  (gptel-make-tool
   :function (lambda (config)
	       (let ((default-directory "~/git/dotfiles/guix"))
		 (async-shell-command (format "make %s" config))))
   :name "update_guix_home"
   :description "Update the guix home configuration"
   :args (list '(:name "config"
		       :type "string"
		       :description "The configuration to update. It's always home"))
   :category "guix")

  ;; Message buffer logging tool
  (gptel-make-tool
   :function (lambda (text)
               (message "%s" text)
               (format "Message sent: %s" text))
   :name "echo_message"
   :description "Send a message to the *Messages* buffer"
   :args (list '(:name "text"
                       :type "string"
                       :description "The text to send to the messages buffer"))
   :category "emacs")

  ;; buffer retrieval tool
  (gptel-make-tool
   :function (lambda (buffer)
               (unless (buffer-live-p (get-buffer buffer))
                 (error "Error: buffer %s is not live." buffer))
               (with-current-buffer  buffer
                 (buffer-substring-no-properties (point-min) (point-max))))
   :name "read_buffer"
   :description "Return the contents of an Emacs buffer"
   :args (list '(:name "buffer"
                       :type "string"
                       :description "The name of the buffer whose contents are to be retrieved"))
   :category "emacs")


  (gptel-make-tool
   :function (lambda (directory)
               (mapconcat #'identity
                          (directory-files directory)
                          "\n"))
   :name "list_directory"
   :description "List the contents of a given directory"
   :args (list '(:name "directory"
                       :type "string"
                       :description "The path to the directory to list"))
   :category "filesystem")

  (gptel-make-tool
   :function (lambda (parent name)
               (condition-case nil
                   (progn
                     (make-directory (expand-file-name name parent) t)
                     (format "Directory %s created/verified in %s" name parent))
                 (error (format "Error creating directory %s in %s" name parent))))
   :name "make_directory"
   :description "Create a new directory with the given name in the specified parent directory"
   :args (list '(:name "parent"
                       :type "string"
                       :description "The parent directory where the new directory should be created, e.g. /tmp")
               '(:name "name"
                       :type "string"
                       :description "The name of the new directory to create, e.g. testdir"))
   :category "filesystem")

  (gptel-make-tool
   :function (lambda (path filename content)
               (let ((full-path (expand-file-name filename path)))
                 (with-temp-buffer
                   (insert content)
                   (write-file full-path))
                 (format "Created file %s in %s" filename path)))
   :name "create_file"
   :description "Create a new file with the specified content"
   :args (list '(:name "path"
                       :type "string"
                       :description "The directory where to create the file")
               '(:name "filename"
                       :type "string"
                       :description "The name of the file to create")
               '(:name "content"
                       :type "string"
                       :description "The content to write to the file"))
   :category "filesystem")

  (gptel-make-tool
   :function (lambda (filepath)
               (with-temp-buffer
                 (insert-file-contents (expand-file-name filepath))
                 (buffer-string)))
   :name "read_file"
   :description "Read and display the contents of a file"
   :args (list '(:name "filepath"
                       :type "string"
                       :description "Path to the file to read.  Supports relative paths and ~."))
   :category "filesystem"))

(use-package mcp
  :ensure t
  :after gptel
  :custom (mcp-hub-servers
           `(("categorize" . (:command "mcp_categorize"))))
  :config (require 'mcp-hub)
  :hook (after-init . mcp-hub-start-all-server))

(use-package gptel-mcp
  :ensure t
  :after mpc
  :straight (:host github :repo "lizqwerscott/gptel-mcp.el" :files ("gptel-mcp.el")))
#+end_src

** Aidermacs

#+begin_src emacs-lisp :tangle ~/.emacs
(use-package aidermacs
  :bind (("C-c m" . aidermacs-transient-menu))
  :custom
  ; See the Configuration section below
  (aidermacs-default-chat-mode 'architect)
  (aidermacs-default-model "sonnet"))
#+end_src

* Music
#+begin_src emacs-lisp :tangle ~/.emacs
(if is-guix
    (progn
      (add-to-list 'load-path "/home/person/.local/share/SuperCollider/downloaded-quarks/scel/el")
      (require 'sclang)
      (load-file "~/git/scel/el/sclang-interp.el")
      (setq sclang-use-pw-jack t)
      ))
#+end_src

#+begin_src emacs-lisp :tangle ~/.emacs
(use-package norns
  :config
  (add-hook 'lua-mode-hook #'norns-mode-maybe-activate)
  (add-hook 'sclang-mode-mode-hook #'norns-mode-maybe-activate)
  :bind (
         :map norns-mode-map
         ;; NB: those keybindings are inspired by John Wiegley's
         ("C-c e b" . norns-load-current-script)
         ("C-c e r" . norns-send-selection)

         :map norns-matron-repl-mode-map
         ("C-c e b" . norns-rerun)

         :map norns-sc-repl-mode-map
         ("C-." . norns-sc-stop))
  )
#+end_src

* Hunting
#+begin_src emacs-lisp :tangle ~/.emacs
(use-package yara-mode)

(use-package deferred)
(require 'deferred)

(use-package hunting-mode
  :straight (:local-repo "~/git/hunting-mode"
			 :files ("lisp/*.el"))
  :config
  (add-to-list 'hunting-glyph-hooks
	       `(,hunting-md5-regex-wrapped hunting-project-hash-contains-p "‚úÖ" "‚ùå")
	       `(,hunting-sha1-regex-wrapped hunting-project-hash-contains-p "‚úÖ" "‚ùå")
	       `(,hunting-sha256-regex-wrapped hunting-project-hash-contains-p "‚úÖ" "‚ùå"))

  (add-hook 'org-mode-hook 'hunting-mode)

  (setq hunting-project-basedir (file-truename (file-name-concat org-roam-directory "projects")))

  (setq hunting-project-current-project "Example")
  (setq hunting-paranoia-level hunting-paranoia-level-active)
  (setq hunting-modeline-toggle 0)
  )

(defvar noonker/radare-hist '("null"))

(defun noonker/open-with-iaito ()
  (interactive)
  (let* ((thing (thing-at-point 'symbol))
	 (choice (if (and thing (hunting-sha256-p thing)) thing
		   (completing-read
		    "Searches: "
		    noonker/radare-hist)))
	 (re-buffer-name (format "*[r2]%s:%s*" hunting-project-current-project choice)))
    (add-to-list 'noonker/radare-hist choice)
    (if (get-buffer re-buffer-name)
	(switch-to-buffer re-buffer-name)
      (start-process (format "*process: %s*" re-buffer-name)
		     (format "*buffer: %s*" re-buffer-name)
		     "iaito"
		     "-e" "bin.cache=true"
		     "-w"
		     "-A"
		     (file-name-concat hunting-project-basedir hunting-project-current-project "samples" choice)
		     )
      
      )))
#+end_src
* Finally
Load my RSS feeds
#+begin_src emacs-lisp :tangle ~/.emacs
(defun noonker/init-other ()
  (interactive)
  (if (not im-at-work)
      (load-file "~/.password-store/Config/elfeed.el.gpg")))
#+end_src

* Feeds 
** Youtube

#+begin_src emacs-lisp :tangle ~/.emacs
(setq youtube-feeds
      '(
	("https://www.youtube.com/feeds/videos.xml?channel_id=UC5fdssPqmmGhkhsJi4VcckA" innuendo-studios youtube)
	("https://www.youtube.com/feeds/videos.xml?channel_id=UCDsElQQt_gCZ9LgnW-7v-cQ" kirsten-dirksen youtube)
	("https://www.youtube.com/feeds/videos.xml?channel_id=UCsXVk37bltHxD1rDPwtNM8Q" kurzgesagt youtube)
	("https://www.youtube.com/feeds/videos.xml?channel_id=UCJXa3_WNNmIpewOtCHf3B0g" laurie-wired youtube)
	("https://www.youtube.com/feeds/videos.xml?channel_id=UCUyeluBRhGPCW4rPe_UvBZQ" prime-time youtube)
	("https://www.youtube.com/feeds/videos.xml?channel_id=UCwHwDuNd9lCdA7chyyquDXw" bread-on-penguins youtube)
	("https://www.youtube.com/feeds/videos.xml?channel_id=UC8gFadPgK2r1ndqLI04Xvvw" maangchi youtube)
	("https://www.youtube.com/feeds/videos.xml?channel_id=UCV5vCi3jPJdURZwAOO_FNfQ" thought-emporium youtube)
	("https://www.youtube.com/feeds/videos.xml?channel_id=UCe2JAC5FUfbxLCfAvBWmNJA" food-lab youtube)
	("https://www.youtube.com/feeds/videos.xml?channel_id=UCWZ3HFiJkxG1K8C4HVnyBvQ" vic-berger youtube)
	("https://www.youtube.com/feeds/videos.xml?channel_id=UCWjmAUHmajb1-eo5WKk_22A" audioTree music youtube)
	("https://www.youtube.com/feeds/videos.xml?channel_id=UC9-y-6csu5WGm29I7JiwpnA" computerphile youtube)
	("https://www.youtube.com/feeds/videos.xml?channel_id=UCSkzHxIcfoEr69MWBdo0ppg" cuck-philosophy youtube)
	("https://www.youtube.com/feeds/videos.xml?channel_id=UCo-3ThNQmPmQSQL_L6Lx1_w" deepsky-videos youtube)
	("https://www.youtube.com/feeds/videos.xml?channel_id=UC-yuWVUplUJZvieEligKBkA" javidx9 youtube)
	("https://www.youtube.com/feeds/videos.xml?channel_id=UCa_8y96THr7LzMg8BsU-sUw" just-wondering youtube)
	("https://www.youtube.com/feeds/videos.xml?channel_id=UC3I2GFN_F8WudD_2jUZbojA" KEXP youtube music)
	("https://www.youtube.com/feeds/videos.xml?channel_id=UCJgBqh3tYway5A5VgV4dZRw" mr-bill youtube music)
	("https://www.youtube.com/feeds/videos.xml?channel_id=UCoxcjq-8xIDTYp3uz647V5A" numberphile youtube)
	("https://www.youtube.com/feeds/videos.xml?channel_id=UC--DwaiMV-jtO-6EvmKOnqg" oa-labs youtube)
	("https://www.youtube.com/feeds/videos.xml?channel_id=UCvBqzzvUBLCs8Y7Axb-jZew" sixety-symbols youtube)
	("https://www.youtube.com/feeds/videos.xml?channel_id=UCGaVdbSav8xWuFWTadK6loA" vlogbrothers youtube)
	("https://www.youtube.com/feeds/videos.xml?channel_id=UCy-AwzC0US6T_DALeiqnLHQ" yan-z youtube music)
	("https://www.youtube.com/feeds/videos.xml?channel_id=UC4eYXhJI4-7wSWc8UNRwD4A" tiny-desk youtube  music)
	("https://www.youtube.com/feeds/videos.xml?channel_id=UCvB3solmhqtgDeLpD-yTtfg" hickok45 youtube )
	("https://www.youtube.com/feeds/videos.xml?channel_id=UCdBnxYbzwu5CypEdMfu4_jA" leeya-katrina youtube music )
	("https://www.youtube.com/feeds/videos.xml?channel_id=UCzIlUODCqKo7Og_OIp66x9g" lucy-riddett youtube music)
	("https://www.youtube.com/feeds/videos.xml?channel_id=UCaB0Vx7zrGJRrOQb42bI99g" milan youtube  music)
	("https://www.youtube.com/feeds/videos.xml?channel_id=UCtc5INMrIDrDEbv2FLK4bVg" natalie-chami youtube music)
	("https://www.youtube.com/feeds/videos.xml?channel_id=UCO8yPl56VVCnRM7qnnBIDew" peter-neils youtube music)
	("https://www.youtube.com/feeds/videos.xml?channel_id=UCdsLnOiepq0GEPpGY14V5Rg" piotr-jagielski youtube music)
	("https://www.youtube.com/feeds/videos.xml?channel_id=UCchFx5hTGnhjya-odX_6Fpw" rory-hoffman youtube music)
	("https://www.youtube.com/feeds/videos.xml?channel_id=UCl-WbRCwODSd2BRQSxJcq2g" tenebrae-chior youtube music)
	("https://www.youtube.com/feeds/videos.xml?channel_id=UC8fqt_PDhDDszL5Zi8EauqA" terminal-passage youtube music)
	("https://www.youtube.com/feeds/videos.xml?channel_id=UCg6IiNQqZWJH3ZFfJhXRMsg" octavism youtube music)
	("https://www.youtube.com/feeds/videos.xml?channel_id=UCrfKGpvbEQXcbe68dzXgJuA" forgotten-weapons youtube)
	("https://www.youtube.com/feeds/videos.xml?channel_id=UCpbx4wlyihmnsBy9uAE_kdA" stick-in-the-wheel youtube music)
	("https://www.youtube.com/feeds/videos.xml?channel_id=UCeUNM9NqJqZXfRNeuW4_2sg" inrangetv youtube)
	("https://www.youtube.com/feeds/videos.xml?channel_id=UCC6KehJqUUrWLlfPCWh7lTA" moshe-zuchter youtube   music)
	("https://www.youtube.com/feeds/videos.xml?channel_id=UCnPl-b0Xw-A20ukIQEJ0_Nw" yuri-charyguine youtube)
	("https://www.youtube.com/feeds/videos.xml?channel_id=UClcE-kVhqyiHCcjYwcpfj9w" liveoverflow youtube)
	("https://www.youtube.com/feeds/videos.xml?channel_id=UCIA8TCSZ-BaBX-aJv92tpRQ" tim-heidecker youtube)
	("https://www.youtube.com/feeds/videos.xml?channel_id=UCCd1Cwjp3hK1tTxevgnHD3g" aline-gingertail youtube music)
	("https://www.youtube.com/feeds/videos.xml?channel_id=UC-_SoG6x0XvcQRgQEh7Ce9Q" dj-cummerbund youtube  music)
	("https://www.youtube.com/feeds/videos.xml?channel_id=UCcXhhVwCT6_WqjkEniejRJQ" wintergatan youtube)
	("https://www.youtube.com/feeds/videos.xml?channel_id=UCw2Veg8X4aCUitGn9xTMi8A" cassie-accordion youtube)
	("https://www.youtube.com/feeds/videos.xml?channel_id=UCltmf0pqjXyLtNsF2vek_wQ" guqin youtube music)
	("https://www.youtube.com/feeds/videos.xml?channel_id=UCdutJyKPX5uOJxNN0wM4g-A" classic-documentary youtube)
	("https://www.youtube.com/feeds/videos.xml?channel_id=UCF3I2RRLRVh_HuXP9sNlhNg" weltmeister youtube music)
	("https://www.youtube.com/feeds/videos.xml?channel_id=UC-AQKm7HUNMmxjdS371MSwg" channel-5 youtube)
	("https://www.youtube.com/feeds/videos.xml?channel_id=UC4eYXhJI4-7wSWc8UNRwD4A" npr-music youtube)
	("https://www.youtube.com/feeds/videos.xml?channel_id=UCk0tHQym-zIaxjrVuTzojdg" embahn youtube music)
	("https://www.youtube.com/feeds/videos.xml?channel_id=UCigygyPkHm07o-wQvkET7Og" george-collier youtubemusic )
	("https://www.youtube.com/feeds/videos.xml?channel_id=UCm9K6rby98W8JigLoZOh6FQ" lock-picking-lawyer youtube)
	("https://www.youtube.com/feeds/videos.xml?channel_id=UCposMD82i8gEmpnSG-rrO1g" mojca youtube music)
	("https://www.youtube.com/feeds/videos.xml?channel_id=UCrCTC5_t-HaVJ025DbYITiw" alice-capelle youtube music)
	("https://www.youtube.com/feeds/videos.xml?channel_id=UCqM0zDcFNdAHj7uQkprLszg" positron youtube)
	("https://www.youtube.com/feeds/videos.xml?channel_id=UCuVLTxl-I0glJYPfcPKJg7w" heymun youtube music)
	("https://www.youtube.com/feeds/videos.xml?channel_id=UCAzPN3ilUBKEU0hcQ0vuxpw" george-secor youtube music)
	("https://www.youtube.com/feeds/videos.xml?channel_id=UCHP9CdeguNUI-_nBv_UXBhw" daniel-naroditsky youtube)
	("https://www.youtube.com/feeds/videos.xml?channel_id=UCJjFX23mI0oZaZirtIgyE-Q" david-lange youtube)
	("https://www.youtube.com/feeds/videos.xml?channel_id=UCzJVGqsvZ3ti197NMIjE5ig" elina-spitsa youtube music)
	("https://www.youtube.com/feeds/videos.xml?channel_id=UC6EnFbK-P5q0zeaqI5yobKg" benjamin-finegold youtube)
	("https://www.youtube.com/feeds/videos.xml?channel_id=UC7shUDSkHjuQNegPhGdANQQ" art-of-listening youtube music)
	("https://www.youtube.com/feeds/videos.xml?channel_id=UC8TZwtZ17WKFJSmwTZQpBTA" my-analogue-journal youtube music)
	("https://www.youtube.com/feeds/videos.xml?channel_id=UCWamialv2ZhqR7BPPu0Niug" side-channel-security youtube)
	("https://www.youtube.com/feeds/videos.xml?channel_id=UCQB04t2hxSBVTjxpbIHdI-w" sam-aaron youtube music)
	("https://www.youtube.com/feeds/videos.xml?channel_id=UCwfYU2M8TBAus0TIaNtjxlQ" jam-in-the-van youtube music)
	("https://www.youtube.com/feeds/videos.xml?channel_id=UCd2KNtfphz8HvYzM4pwtHmg" like-a-version youtube music)
	("https://www.youtube.com/feeds/videos.xml?channel_id=UCz5RHlX7cGeayKn4FU6u7tA" little-elephant youtube music)
	("https://www.youtube.com/feeds/videos.xml?channel_id=UCBQ8NG_fqzmAmGEriQW1XZQ" our-vinyl youtube music)
	("https://www.youtube.com/feeds/videos.xml?channel_id=UCOCjoq4cms20Ik39r1aOqXA" cardinal-sessions youtube music)
	("https://www.youtube.com/feeds/videos.xml?channel_id=UCfKl318qMJ2p8TUmfL4wdPQ" songs-from-the-shed youtube music)
	("https://www.youtube.com/feeds/videos.xml?channel_id=UChsZje1ssMSDgWoxm4VQn_w" wild-honey-pie youtube music)
	("https://www.youtube.com/feeds/videos.xml?channel_id=UCG36u-k09zdIPQh5EEdVgTA" mahogany-music youtube  Mahogany music)
	("https://www.youtube.com/feeds/videos.xml?channel_id=UCRLZb8PpI9N7COmYqHiDH7A" sofar-sounds youtube music)
	("https://www.youtube.com/feeds/videos.xml?channel_id=UC_VZvcOjwfLK0BY79tB-moQ" melodart youtube music)
	("https://www.youtube.com/feeds/videos.xml?channel_id=UC7kIy8fZavEni8Gzl8NLjOQ" alexoconnor youtube)
	("https://www.youtube.com/feeds/videos.xml?channel_id=UCDIJ45Bba6nzrGL5v8b7fMw" conneromalley youtube)
	("https://www.youtube.com/feeds/videos.xml?channel_id=UCNAxrHudMfdzNi6NxruKPLw" samharris youtube)
	("https://www.youtube.com/feeds/videos.xml?channel_id=UCASM0cgfkJxQ1ICmRilfHLw" patrick-boyle youtube)
	))
#+end_src

** Podcasts
#+begin_src emacs-lisp :tangle ~/.emacs
(setq podcast-feeds
      '(
	("http://feeds.99percentinvisible.org/99percentinvisible" 99pi podcast)
	("https://feeds.buzzsprout.com/244372.rss" crazy-town podcast)
	("http://rss.acast.com/nature" nature podcast)
	("https://feeds.eff.org/howtofixtheinternet" how-to-fix-the-internet podcast)
	("https://feeds.megaphone.fm/search-engine" search-engine podcast)
	("https://feeds.megaphone.fm/TBIEA2761282490" four-oh-four podcast)
	("http://feeds.feedburner.com/birdnote/OYfP" bird-note podcast) 
	("https://www.kcrw.com/culture/shows/nocturne/rss.xml" nocturne podcast)
	("http://feeds.wnyc.org/onthemedia" on-the-media podcast)
	("https://www.npr.org/rss/podcast.php?id=510289" planet-money podcast)
	("http://rss.acast.com/pulseoftheplanet" pulse-of-the-planet podcast) 
	("http://feeds.wnyc.org/radiolab" radiolab  podcast)
	("https://anchor.fm/s/7f22824/podcast/rss" sounds-by-nature podcast)
	("https://www.ecoshock.org/feed/lofi" radio-ecoshock podcast)
	("http://feeds.wpr.org/wpr-politics" wpr-politics podcast)
	("http://feeds.wnyc.org/tnypoetry" new-yorker-poetry podcast) 
	("https://feeds.simplecast.com/p7Q9jZ0K" poem-of-the-day podcast)
	("https://www.npr.org/rss/podcast.php?id=510019" all-songs-considered podcast)
	("https://feeds.megaphone.fm/darknetdiaries" darknet-diaries podcast)
	("https://feeds.simplecast.com/dxZsm5kX" pod-save-america podcast)
	))
#+end_src

** Listen to this
#+begin_src emacs-lisp :tangle ~/.emacs
(setq music-firehose-feeds
      '(
      ("https://www.reddit.com/r/listentothis/.rss" listen-to-this music reddit)
      ))
#+end_src

** Government Firehoses
#+begin_src emacs-lisp
(setq government-feeds
      '(
	("https://www.sec.gov/cgi-bin/browse-edgar?action=getcompany&CIK=0001078075&type=&dateb=&owner=include&start=0&count=40&output=atom" sec gov first sec)
	("https://www.ftc.gov/feeds/press-release.xml" ftc gov first ftc)
	("https://www.ftc.gov/feeds/press-release-competition.xml" gov first ftc)
	("https://www.ftc.gov/feeds/press-release-consumer-protection.xml" gov first ftc)
	("https://api2.fcc.gov/edocs/public/api/v1/rss/" gov first fcc)
	("https://api2.fcc.gov/edocs/public/api/v1/rss/docTypes/Cit" gov first fcc)
	("http://licensing.fcc.gov/myibfs/yesterdaysFilingsFeed.do" gov first fcc)
	("http://licensing.fcc.gov/myibfs/yesterdaysActionsFeed.do" gov first fcc)
	("http://licensing.fcc.gov/myibfs/recentPNFeed.do" gov first fcc)
	("http://efilingapps.fec.gov/rss/generate?preDefinedFilingType=ALL" gov first fec)
	("https://efilingapps.fec.gov/rss/generate?preDefinedFilingType=ALL" gov fec first)
	("https://www.nsa.gov/DesktopModules/ArticleCS/RSS.ashx?ContentType=1&Site=920&max=20" gov first nsa)
	))
#+end_src

** Security Feeds
#+begin_src emacs-lisp :tangle ~/.emacs
(setq security-feeds
      '(
       ("https://www.amnesty.org/en/latest/feed/" amnesty security second skim)
	("https://media.ccc.de/updates.rdf" ccc security second skim)
	("https://www.us-cert.gov/ncas/alerts.xml" us-cert-alerts security second skim)
	("https://www.cisa.gov/cybersecurity-advisories/all.xml" us-certs-all security second skim)
	("https://securelist.com/feed/" securelist security second skim)
	("http://blog.dynamoo.com/feeds/posts/default" dynamoo security second skim)
	("http://feeds.feedburner.com/feedburner/Talos?format=xml" cisco-talos security second skim)
	("https://newsroom.trendmicro.com/news-releases?pagetemplate=rss&category=787" trend-micro security second skim)
	("https://feeds.feedburner.com/PaloAltoNetworks" unit42 security second skim)
	("https://www.proofpoint.com/rss.xml" proofpoint security second skim)
	("http://asert.arbornetworks.com/feed/" arbor-networks security second skim)
	("http://addxorrol.blogspot.com/feeds/posts/default" addxorrol security second skim)
	("http://herrcore.blogspot.com/feeds/posts/default" herrcore security second skim)
	("https://threatlabz.zscaler.com/blogs" zscalar security second skim)
	("http://googleonlinesecurity.blogspot.com/atom.xml" google-security security second skim)
	("http://bartblaze.blogspot.com/feeds/posts/default" bartblaze security second skim)
	("https://www.exploit-db.com/rss.xml" exploit-db security second skim) 
	("https://bittherapy.net/post/index.xml" bittherapy security second skim)
	("http://malwaredomains.com/?feed=rss2" malware-domains security second skim)
	("http://windowsir.blogspot.com/feeds/posts/default" windows-incident-response security second skim)
	("http://www.schneier.com/blog/index.rdf" schneier-on-security security second skim)
	("http://contagiodump.blogspot.com/feeds/posts/default" contagio security second skim)
	("http://feeds.feedburner.com/darknethackers" darknet-hackers security second skim)
	("http://securityaffairs.co/wordpress/feed" security-affairs security second skim)
	("http://blog.invisiblethings.org/feed.xml" invisible-things security second skim)
	("https://threatpost.com/feed" threatpost security second skim)
	("http://hackingexposedcomputerforensicsblog.blogspot.com/feeds/posts/default" hacking-exposed security second skim)
	("http://detect-respond.blogspot.com/feeds/posts/default" detect-respond security second skim)
	("https://feeds.feedburner.com/threatintelligence/pvexyqv7v0v" fireeye security second skim)
	("http://www.elsevierscitech.com/feeds/feeds/b2b/14.xml" elsevierscitech security second skim)
	("https://malware.dontneedcoffee.com/feed.xml" dont-need-coffee security second skim)
	("https://www.darktrace.com/blog/index.xml" darktrace security second skim)
	("http://krebsonsecurity.com/feed/" krebs-on-security security second skim)
	("http://www.swiftforensics.com/feeds/posts/default" swift-forensics security second skim)
	("http://www.darkreading.com/rss.xml" dark-reading security second skim)
	("http://taosecurity.blogspot.com/atom.xml" tao-security security second skim)
	("https://isc.sans.edu/rssfeed_full.xml" sans security second skim)
	("http://blog.malwarebytes.org/feed/" malware-bytes security second skim)
	("https://www.wired.com/feed/category/security/latest/rss" wired security second skim)
	("http://ryanstillions.blogspot.com/feeds/posts/default" ryan-stillions security second skim)
	("http://www.theregister.co.uk/security/headlines.atom" register security second skim)
	("https://www.recordedfuture.com/feed/" recorded-future security second skim)
	("http://www.malware-traffic-analysis.net/blog-entries.rss" malware-traffic-analysis security second skim)
	("https://www.bellingcat.com/feed/" bellingcat security second skim)
	("https://www.clearskysec.com/feed/" clearsky-sec security second skim)
	("https://thecomputerperson.wordpress.com/rss" the-computer-person security second skim)
	("https://dfir.it/atom.xml" dfir-it re)
	("https://www.msreverseengineering.com/blog?format=rss" ms-reverse-engineering security second skim re)
	("https://www.wired.com/feed/category/security/latest/rss" wired-security tech)
	("https://www.sentinelone.com/blog/rss" sentinel-one tech security)
	("https://labs.f-secure.com/blog/rss" f-secure tech security)
	("https://euvsdisinfo.eu/articles/feed" eu-disinfo security)
	("https://www.megabeets.net/rss" megabeets tech)
	("https://pluralistic.net/feed/" pluralistic tech)
	("https://seclists.org/rss/fulldisclosure.rss" second skim seclists tech security)
	("https://www.404media.co/rss" 404media tech security)
	("https://feeds.feedburner.com/TheHackersNews" second skim thehackernews tech security)
	("https://monome.org/rss.xml" monome tech)
	))
#+end_src

** Mobile Feeds
#+begin_src emacs-lisp :tangle ~/.emacs
(setq mobile-feeds
      '(
        ("https://www.nowsecure.com/blog/category/research-threat-intel/rss" nowsecure mobile)
        ("https://citizenlab.org/feed/" citizenlab mobile)
        ("https://blog.lookout.com/topics#/researchers/" lookout mobile)
        ("https://blog.zimperium.com/feed/" zimperium mobile)
        ("https://blog.pulsesecure.net/feed/" pulse-secure mobile)
        ("http://www.f-secure.com/weblog/weblog.rss" f-secure mobile)
        ("https://blog.google/threat-analysis-group/rss/" google-tao mobile)
	))
#+end_src

** Comics
#+begin_src emacs-lisp :tangle ~/.emacs
(setq comic-feeds '(
		    ("http://pbfcomics.com/feed/feed.xml" pbfcomics comics)
		    ("http://existentialcomics.com/rss.xml" existential-comics comics)
		    ("http://xkcd.com/rss.xml" xkcd comics)
		    ))
#+end_src
** Art Feeds
#+begin_src emacs-lisp :tangle ~/.emacs
(setq art-feeds
      '(
	("https://doorofperception.com/rss" door-of-perception art)
	))
#+end_src
** Culture Feeds
#+begin_src emacs-lisp :tangle ~/.emacs
(setq culture-feeds
      '(
	("https://thebaffler.com/latest/feed" the-baffler lefty news)
	("https://www.resilience.org/feed/" resillience lefty news)
	("https://www.newyorker.com/feed/everything" new-yorker lefty)
	("https://defector.com/feed/" defector lefty)
	("http://jacobinmag.com/feed" jacobin lefty)
	("https://journalofcontroversialideas.org/rss" controvertial-ideas lefty)
	("https://www.documentjournal.com/category/above-the-fold/rss" document-journal lefty)
	("https://dansinker.com/feed.xml" dansinker)
	))
#+end_src

** Live Feeds
#+begin_src emacs-lisp :tangle ~/.emacs
(setq news-live-feeds
      '(
	("http://rss.nytimes.com/services/xml/rss/nyt/HomePage.xml" news first skim)
	("http://feeds.propublica.org/propublica/main" first skim)
	))
#+end_src

** Local Feeds
#+begin_src emacs-lisp :tangle ~/.emacs
(setq local-feeds
      '(
	("https://gopresstimes.com/de-pere" go-press-times local)
	("http://host.madison.com/search/?f=rss&t=article&c=news/state_and_regional&q=%23wsj&l=25&s=start_time&sd=desc" madison-news local)
	))
#+end_src

** Tech Feeds
#+begin_src emacs-lisp :tangle ~/.emacs
(setq tech-feeds
      '(
	("https://100r.co/links/rss.xml" 100rabbits blog tech)
	("https://nomasters.io/index.xml" nomasters blog tech)
	("https://blog.codinghorror.com/rss/" coding-horror tech)
	("https://www.rtl-sdr.com/feed/" rtl-sdr tech)
	("https://nullprogram.com/feed/" null-program tech blog emacs)
	("https://www.theverge.com/policy/rss/index.xml" the-verge tech)
	("https://wrongbaud.github.io/feed.xml" wrong-baud second tech)
	("https://usesthis.com/feed.atom" uses-this tech)
	("https://irreal.org/blog/?feed=rss2" irreal emacs)
	("https://feeds.sachachua.com/sachac" sachachua emacs)
	("https://ciechanow.ski/atom.xml" ciechanow tech)
	("https://cdn.jwz.org/blog/feed/" jwz tech)
	("https://lwn.net/headlines/rss" lwn tech)
	("https://blog.onloop.net/rss" onloop tech)
	("https://blog.oimo.io/rss" oimo tech)
	("https://johnnydecimal.com/rss.xml" johnnydecimal tech)
	("https://hnrss.org/frontpage" hackernews tech)
	("https://fossacademic.tech/feed.xml" fossacademic tech)
	("https://www.stallman.org/rss/rss.xml" stallman emacs tech gnu)
	("https://joshblais.com/index.xml" joshua-blais emacs tech)
	("https://aartaka.me/rss.xml" aartaka emacs tech)
	))
#+end_src

** Combine
#+begin_src emacs-lisp :tangle ~/.emacs
(setq elfeed-feeds (append art-feeds
			   comic-feeds
			   ;; government-feeds
			   culture-feeds
			   local-feeds
			   mobile-feeds
			   music-firehose-feeds
			   news-live-feeds
			   podcast-feeds
			   security-feeds
			   tech-feeds
			   youtube-feeds))
#+end_src

** Helper
#+begin_src emacs-lisp :tangle ~/.emacs
(defun feed-to-rss2email-feed (feed)
  (with-temp-buffer (mapcar (lambda (x) (insert (format "[feed.%s]\nurl = %s\n\n"
							(nth 1 x)
							(nth 0 x)))) feed)
		    (kill-region (point-min) (point-max)))
  )
#+end_src

* Shortcuts

#+begin_src emacs-lisp :tangle ~/.emacs
;; Initial States
(evil-set-initial-state 'magit-status-mode 'emacs)
(evil-set-initial-state 'kubel-mode 'emacs)

;; Trying out leader
(use-package which-key
  :ensure t
  :config
  (which-key-mode))

(evil-set-leader 'visual (kbd "SPC"))
(evil-set-leader 'normal (kbd "SPC"))

;; Create prefix maps for organization
(define-prefix-command 'noonker-file-map)
(define-prefix-command 'noonker-buffer-map)
(define-prefix-command 'noonker-window-map)
(define-prefix-command 'noonker-search-map)
(define-prefix-command 'noonker-help-map)
(define-prefix-command 'noonker-project-map)
(define-prefix-command 'noonker-code-map)
(define-prefix-command 'noonker-toggle-map)
(define-prefix-command 'noonker-org-map)
(define-prefix-command 'noonker-edit-map)
(define-prefix-command 'noonker-ai-map)
(define-prefix-command 'noonker-hunting-map)

;; Bind prefix maps to leader key
(evil-define-key '(normal visual) 'global (kbd "<leader>f") noonker-file-map)
(evil-define-key '(normal visual) 'global (kbd "<leader>e") noonker-edit-map)
(evil-define-key '(normal visual) 'global (kbd "<leader>b") noonker-buffer-map)
(evil-define-key '(normal visual) 'global (kbd "<leader>w") noonker-window-map)
(evil-define-key '(normal visual) 'global (kbd "<leader>s") noonker-search-map)
(evil-define-key '(normal visual) 'global (kbd "<leader>h") noonker-help-map)
(evil-define-key '(normal visual) 'global (kbd "<leader>p") noonker-project-map)
(evil-define-key '(normal visual) 'global (kbd "<leader>i") noonker-code-map)
(evil-define-key '(normal visual) 'global (kbd "<leader>t") noonker-toggle-map)
(evil-define-key '(normal visual) 'global (kbd "<leader>o") noonker-org-map)
(evil-define-key '(normal visual) 'global (kbd "<leader>a") noonker-ai-map)
(evil-define-key '(normal visual) 'global (kbd "<leader>r") noonker-hunting-map)

;; Set which-key prefixes for better organization
(which-key-add-key-based-replacements "SPC f" "files")
(which-key-add-key-based-replacements "SPC e" "edit")
(which-key-add-key-based-replacements "SPC b" "buffers")
(which-key-add-key-based-replacements "SPC w" "windows")
(which-key-add-key-based-replacements "SPC s" "search")
(which-key-add-key-based-replacements "SPC h" "help")
(which-key-add-key-based-replacements "SPC p" "projects")
(which-key-add-key-based-replacements "SPC c" "code")
(which-key-add-key-based-replacements "SPC t" "toggles")
(which-key-add-key-based-replacements "SPC o" "org")
(which-key-add-key-based-replacements "SPC a" "ai")

;; File commands
(define-key noonker-file-map (kbd "f") 'find-file)
(define-key noonker-file-map (kbd "r") 'recentf-open-files)
(define-key noonker-file-map (kbd "s") 'save-buffer)
(define-key noonker-file-map (kbd "S") 'write-file)
(define-key noonker-file-map (kbd "d") 'dired-jump)

;; Buffer commands
(define-key noonker-buffer-map (kbd "b") 'switch-to-buffer)
(define-key noonker-buffer-map (kbd "d") 'kill-current-buffer)
(define-key noonker-buffer-map (kbd "n") 'next-buffer)
(define-key noonker-buffer-map (kbd "p") 'previous-buffer)
(define-key noonker-buffer-map (kbd "R") 'revert-buffer)

;; Window commands
(define-key noonker-window-map (kbd "3") 'split-window-right)
(define-key noonker-window-map (kbd "2") 'split-window-below)
(define-key noonker-window-map (kbd "0") 'delete-window)
(define-key noonker-window-map (kbd "1") 'delete-other-windows)
(define-key noonker-window-map (kbd "o") 'other-window)

;; Search commands
(define-key noonker-search-map (kbd "s") 'isearch-forward)  ;; Or swiper if you have it
(define-key noonker-search-map (kbd "r") 'query-replace)

;; Help commands
(define-key noonker-help-map (kbd "f") 'describe-function)
(define-key noonker-help-map (kbd "v") 'describe-variable)
(define-key noonker-help-map (kbd "k") 'describe-key)
(define-key noonker-help-map (kbd "m") 'describe-mode)

;; Project commands 
(define-key noonker-project-map (kbd "f") 'projectile-find-file)
(define-key noonker-project-map (kbd "p") 'projectile-switch-project)
(define-key noonker-project-map (kbd "b") 'projectile-switch-to-buffer)

;; Code commands 
(define-key noonker-code-map (kbd "d") 'lsp-find-definition)
(define-key noonker-code-map (kbd "r") 'lsp-find-references)
(define-key noonker-code-map (kbd "f") 'lsp-format-buffer)
(define-key noonker-code-map (kbd "c") 'compile)
(define-key noonker-code-map (kbd "t") 'elpy-test)
(define-key noonker-code-map (kbd "g") 'magit)
(define-key noonker-code-map (kbd "e") 'emoji-insert)

;; Toggle commands
(define-key noonker-toggle-map (kbd "l") 'display-line-numbers-mode)
(define-key noonker-toggle-map (kbd "w") 'whitespace-mode)
(define-key noonker-toggle-map (kbd "n") 'global-display-line-numbers-mode)

;; Org commands 
(define-key noonker-org-map (kbd "a") 'org-agenda)
(define-key noonker-org-map (kbd "c") 'org-capture)
(define-key noonker-org-map (kbd "r") 'org-roam-capture)
(define-key noonker-org-map (kbd "l") 'org-store-link)
(define-key noonker-org-map (kbd "L") 'org-insert-link)

;; Edit Commands
(define-key noonker-edit-map (kbd "r") 'query-replace)
(define-key noonker-edit-map (kbd "R") 'query-replace-regexp)
(define-key noonker-edit-map (kbd "o") 'occur)

;; AI Commands
(define-key noonker-ai-map (kbd "q") 'gptel-quick)
(define-key noonker-ai-map (kbd "a") 'gptel-send)
(define-key noonker-ai-map (kbd "m") 'gptel-menu)
(define-key noonker-ai-map (kbd "l") 'gptel-lookup)
(define-key noonker-ai-map (kbd "d") 'gptel-debug)
(define-key noonker-ai-map (kbd "r") 'gptel-code-rewrite-and-replace)
(define-key noonker-ai-map (kbd "e") 'gptel-editor-rewrite-and-replace)

;; Hunting Commands
(define-key noonker-hunting-map "r" 'noonker/open-with-iaito)
(define-key noonker-hunting-map "i" 'noonker/open-with-ida)
(define-key noonker-hunting-map "t" 'hunting-project-test-analyzer)
(define-key noonker-hunting-map "y" 'hunting-project-test-yara)


;; Add a few direct bindings to leader for common operations 
(evil-define-key '(normal visual) 'global (kbd "<leader>.") 'find-file) ;; Quick access to find-file
(evil-define-key '(normal visual) 'global (kbd "<leader>2") 'switch-to-buffer) ;; Quick buffer switch
(evil-define-key '(normal visual) 'global (kbd "<leader>3") 'yank-from-kill-ring) ;; Quick buffer switch
(evil-define-key '(normal visual) 'global (kbd "<leader>4") 'bookmark-jump) ;; Quick buffer switch
(evil-define-key '(normal visual) 'global (kbd "<leader>SPC") 'execute-extended-command)
(evil-define-key '(normal visual) 'global (kbd "<leader>ESC") 'keyboard-quit) 
(evil-define-key '(normal visual) 'global (kbd "<leader>g") 'keyboard-quit) 
(evil-define-key '(normal visual) 'global (kbd "<leader>x") 'eval-last-sexp) 
(evil-define-key '(normal visual) 'global (kbd "<leader>u") 'undo)
(evil-define-key '(normal visual) 'global (kbd "<leader>j") 'er/expand-region)
(evil-define-key '(normal visual) 'global (kbd "<leader>k") 'er/contract-region)
#+end_src

* Work Config
#+begin_src emacs-lisp :tangle ~/.emacs
(if im-at-work
    (progn
      (org-babel-lob-ingest "~/org/config.org")
      (org-sbe work-config)))
#+end_src
